<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Regularity Race Timer</title>
    <link rel="manifest" href="/manifest.json">
    <link rel="icon" type="image/png" sizes="48x48" href="favicon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">
    <link rel="shortcut icon" href="favicon.png">
    <meta name="theme-color" content="#1e40af">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="/logo.png">
    <script crossorigin src="lib/react.production.min.js"></script>
    <script crossorigin src="lib/react-dom.production.min.js"></script>
    <script src="lib/babel.min.js"></script>
    <script src="lib/tailwind.min.js"></script>
    <script src="lib/jspdf.umd.min.js"></script>
    <script src="lib/jspdf.plugin.autotable.min.js"></script>
    <script src="lib/chart.umd.min.js"></script>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // Lucide React Icons as inline SVG components
        const Flag = ({ className }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 21v-4m0 0V5a2 2 0 012-2h6.5l1 1H21l-3 6 3 6h-8.5l-1-1H5a2 2 0 00-2 2zm9-13.5V9" />
            </svg>
        );

        const Plus = ({ className }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4v16m8-8H4" />
            </svg>
        );

        const Trash2 = ({ className }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
            </svg>
        );

        const Download = ({ className }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
            </svg>
        );

        const Database = ({ className }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4m0 5c0 2.21-3.582 4-8 4s-8-1.79-8-4" />
            </svg>
        );

        const Upload = ({ className }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" />
            </svg>
        );

        const RefreshCw = ({ className }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
            </svg>
        );

        const FileText = ({ className }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
            </svg>
        );

        const X = ({ className }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
            </svg>
        );

        const Users = ({ className }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
            </svg>
        );

        const BarChart = ({ className }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
            </svg>
        );

        const Repeat = ({ className }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
            </svg>
        );

        const Settings = ({ className }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
            </svg>
        );

        const ChevronDown = ({ className }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" />
            </svg>
        );

        const AlertCircle = ({ className }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
            </svg>
        );

        function BlindFreddyRaceTimer() {
            // Helper function to format time as MM:SS.mmm
            const formatTime = (seconds) => {
                const mins = Math.floor(seconds / 60);
                const secs = seconds % 60;
                return `${mins}:${secs.toFixed(3).padStart(6, '0')}`;
            };

            // Helper function to format time in seconds with milliseconds
            const formatTimeWithMilliseconds = (seconds) => {
                return `${seconds.toFixed(3)}s`;
            };

            // Helper function to parse MM:SS.mmm format to seconds
            const parseTimeInput = (timeString) => {
                if (!timeString) return null;
                const parts = timeString.split(':');
                if (parts.length === 2) {
                    const mins = parseInt(parts[0]) || 0;
                    const secs = parseFloat(parts[1]) || 0;
                    return mins * 60 + secs;
                } else if (parts.length === 1) {
                    // If just a number, treat as seconds
                    return parseFloat(timeString);
                }
                return null;
            };

            // Team-based data structure
            const [teams, setTeams] = useState([
                {
                    id: 1,
                    name: 'Blind Freddy',
                    raceName: '',
                    sessionNumber: '',
                    sessionDuration: '',
                    drivers: [
                        { id: 1, name: 'Harry', targetTime: 105, laps: [], penaltyLaps: 0 },
                        { id: 2, name: 'Dave', targetTime: 105, laps: [], penaltyLaps: 0 },
                        { id: 3, name: 'Tom', targetTime: 105, laps: [], penaltyLaps: 0 },
                        { id: 4, name: 'Neil', targetTime: 105, laps: [], penaltyLaps: 0 }
                    ]
                }
            ]);
            const [activeTeam, setActiveTeam] = useState(0);
            const [activeDriver, setActiveDriver] = useState(0);
            const [lapInput, setLapInput] = useState('');
            const [elapsedTime, setElapsedTime] = useState(0);
            const [isRunning, setIsRunning] = useState(false);
            const [timerDriverIndex, setTimerDriverIndex] = useState(null);
            const [showWarning, setShowWarning] = useState(false);
            const startTimeRef = useRef(null);
            const intervalRef = useRef(null);
            const lastLapTimeRef = useRef(null);
            const beforeTargetBeepPlayedRef = useRef(false);
            const afterStartBeepPlayedRef = useRef(false);
            const [timerResetTrigger, setTimerResetTrigger] = useState(0);
            const [isDarkMode, setIsDarkMode] = useState(() => {
                const saved = localStorage.getItem('darkMode');
                if (saved !== null) return saved === 'true';
                return window.matchMedia('(prefers-color-scheme: dark)').matches;
            });
            const [showSettings, setShowSettings] = useState(false);
            const [audioSettings, setAudioSettings] = useState(() => {
                const saved = localStorage.getItem('audioSettings');
                if (saved) {
                    const parsed = JSON.parse(saved);
                    // Ensure enabled property exists (default to true for backwards compatibility)
                    if (parsed.enabled === undefined) parsed.enabled = true;
                    if (parsed.beforeTargetEnabled === undefined) parsed.beforeTargetEnabled = true;
                    if (parsed.afterLapStartEnabled === undefined) parsed.afterLapStartEnabled = true;
                    return parsed;
                }
                return {
                    enabled: true,
                    beforeTargetEnabled: true,
                    afterLapStartEnabled: true,
                    beforeTargetTime: 10,
                    afterLapStart: 15
                };
            });
            const [lapTypeValues, setLapTypeValues] = useState(() => {
                const saved = localStorage.getItem('lapTypeValues');
                if (saved) return JSON.parse(saved);
                return {
                    bonus: 2,
                    base: 1,
                    changeover: 1,
                    broken: 0,
                    safety: 0
                };
            });
            const [showTeamScoring, setShowTeamScoring] = useState(false);
            const [showTeamSettings, setShowTeamSettings] = useState(false);
            const [showDriverSwitch, setShowDriverSwitch] = useState(false);
            const [changeoverLapInfo, setChangeoverLapInfo] = useState(null);
            const [showCharts, setShowCharts] = useState(false);
            const [showClearDropdown, setShowClearDropdown] = useState(false);
            const [showDataDropdown, setShowDataDropdown] = useState(false);
            const [contextMenu, setContextMenu] = useState({ visible: false, x: 0, y: 0, teamIndex: null, driverIndex: null, lapIndex: null });
            const [editingLap, setEditingLap] = useState({ teamIndex: null, driverIndex: null, lapIndex: null, value: '' });

            // Load data from localStorage on mount
            useEffect(() => {
                const savedTeams = localStorage.getItem('blindFreddyRaceTeams');
                const savedActiveTeam = localStorage.getItem('blindFreddyActiveTeam');
                const savedActiveDriver = localStorage.getItem('blindFreddyActiveDriver');

                if (savedTeams) {
                    const parsedTeams = JSON.parse(savedTeams);
                    setTeams(parsedTeams);
                }
                if (savedActiveTeam !== null) {
                    setActiveTeam(JSON.parse(savedActiveTeam));
                }
                if (savedActiveDriver !== null) {
                    setActiveDriver(JSON.parse(savedActiveDriver));
                }
            }, []);

            // Save data to localStorage whenever it changes
            useEffect(() => {
                localStorage.setItem('blindFreddyRaceTeams', JSON.stringify(teams));
                localStorage.setItem('blindFreddyActiveTeam', JSON.stringify(activeTeam));
                localStorage.setItem('blindFreddyActiveDriver', JSON.stringify(activeDriver));
            }, [teams, activeTeam, activeDriver]);

            // Save theme to localStorage
            useEffect(() => {
                localStorage.setItem('darkMode', isDarkMode.toString());
            }, [isDarkMode]);

            // Save audio settings to localStorage
            useEffect(() => {
                localStorage.setItem('audioSettings', JSON.stringify(audioSettings));
            }, [audioSettings]);

            // Save lap type values to localStorage
            useEffect(() => {
                localStorage.setItem('lapTypeValues', JSON.stringify(lapTypeValues));
            }, [lapTypeValues]);

            // Close dropdown when clicking outside
            useEffect(() => {
                const handleClickOutside = (e) => {
                    const clickedElement = e.target.closest('.relative');
                    if (!clickedElement) {
                        if (showClearDropdown) setShowClearDropdown(false);
                        if (showDataDropdown) setShowDataDropdown(false);
                    }
                };

                document.addEventListener('mousedown', handleClickOutside);
                return () => document.removeEventListener('mousedown', handleClickOutside);
            }, [showClearDropdown, showDataDropdown]);

            // Close context menu when clicking anywhere or pressing Escape
            useEffect(() => {
                const handleCloseContextMenu = (e) => {
                    if (contextMenu.visible) {
                        setContextMenu({ visible: false, x: 0, y: 0, teamIndex: null, driverIndex: null, lapIndex: null });
                    }
                };

                const handleEscape = (e) => {
                    if (e.key === 'Escape' && contextMenu.visible) {
                        setContextMenu({ visible: false, x: 0, y: 0, teamIndex: null, driverIndex: null, lapIndex: null });
                    }
                };

                if (contextMenu.visible) {
                    document.addEventListener('click', handleCloseContextMenu);
                    document.addEventListener('keydown', handleEscape);
                    return () => {
                        document.removeEventListener('click', handleCloseContextMenu);
                        document.removeEventListener('keydown', handleEscape);
                    };
                }
            }, [contextMenu.visible]);

            // Global keyboard handler for Enter key and Spacebar
            useEffect(() => {
                const handleGlobalKeyPress = (e) => {
                    if (e.key === 'Enter' || e.key === 'Return' || e.key === ' ') {
                        e.preventDefault();
                        addLap();
                    }
                };

                window.addEventListener('keydown', handleGlobalKeyPress);
                return () => window.removeEventListener('keydown', handleGlobalKeyPress);
            }, [isRunning, elapsedTime, lapInput, activeDriver, activeTeam, teams]);

            // Reset beep flags when timer is reset
            useEffect(() => {
                beforeTargetBeepPlayedRef.current = false;
                afterStartBeepPlayedRef.current = false;
            }, [timerResetTrigger]);

            // Stopwatch timer effect
            useEffect(() => {
                if (isRunning) {
                    intervalRef.current = setInterval(() => {
                        const now = Date.now();
                        const elapsed = Math.floor((now - startTimeRef.current) / 10) / 100;
                        setElapsedTime(elapsed);

                        // Audio warning: X seconds after lap start
                        if (audioSettings.afterLapStartEnabled && elapsed >= audioSettings.afterLapStart && !afterStartBeepPlayedRef.current) {
                            console.log('After start beep triggered at', elapsed, 'seconds');
                            playBeep(true); // Double beep for after lap start
                            afterStartBeepPlayedRef.current = true;
                        }

                        // Check for warning before target time
                        if (timerDriverIndex !== null) {
                            const driver = teams[0].drivers[timerDriverIndex];
                            const timeUntilTarget = driver.targetTime - elapsed;

                            // Audio warning: X seconds before target time
                            if (audioSettings.beforeTargetEnabled && timeUntilTarget <= audioSettings.beforeTargetTime && timeUntilTarget > 0 && !beforeTargetBeepPlayedRef.current) {
                                console.log('Before target beep triggered at', elapsed, 'seconds, time until target:', timeUntilTarget);
                                playBeep();
                                beforeTargetBeepPlayedRef.current = true;
                            }

                            // Show visual warning when less than 10 seconds remain
                            if (timeUntilTarget <= 10 && timeUntilTarget > 0) {
                                setShowWarning(true);
                            } else {
                                setShowWarning(false);
                            }
                        }
                    }, 10);
                } else {
                    if (intervalRef.current) {
                        clearInterval(intervalRef.current);
                    }
                    setShowWarning(false);
                }
                return () => {
                    if (intervalRef.current) {
                        clearInterval(intervalRef.current);
                    }
                };
            }, [isRunning, timerDriverIndex, teams, audioSettings]);

            const startStopwatch = () => {
                startTimeRef.current = Date.now();
                setElapsedTime(0);
                setIsRunning(true);
                setTimerDriverIndex(activeDriver);
                setShowWarning(false);
                setTimerResetTrigger(prev => prev + 1); // Trigger beep flag reset
            };

            const stopStopwatch = () => {
                setIsRunning(false);
            };

            const resetStopwatch = () => {
                setIsRunning(false);
                setElapsedTime(0);
                setTimerDriverIndex(null);
                if (intervalRef.current) {
                    clearInterval(intervalRef.current);
                }
            };

            const calculateLapType = (delta, isChangeover = false, isSafety = false) => {
                // Changeover laps are marked separately
                if (isChangeover) {
                    return 'changeover';
                }

                // Safety car laps are marked separately
                if (isSafety) {
                    return 'safety';
                }

                // delta is lapTime - targetTime
                // Bonus Lap: within +0.99 seconds of nominated time (0 to +0.99)
                // Base Lap: slower than +0.99 seconds
                // Broken Lap: any amount faster (negative delta)

                if (delta < 0) {
                    return 'broken'; // Too fast = BROKEN LAP
                } else if (delta >= 0 && delta <= 0.99) {
                    return 'bonus'; // Within +0.99s = BONUS LAP (counts as 2 laps: 1 base + 1 bonus)
                } else {
                    return 'base'; // Slower than +0.99s = BASE LAP (counts as 1 lap)
                }
            };

            const calculateLapValue = (lapType) => {
                // Use configurable lap type values
                if (lapType === 'safety') return lapTypeValues.safety;
                if (lapType === 'changeover') return lapTypeValues.changeover;
                if (lapType === 'bonus') return lapTypeValues.bonus;
                if (lapType === 'base') return lapTypeValues.base;
                if (lapType === 'broken') return lapTypeValues.broken;
                return 1;
            };

            const addLap = () => {
                const updatedTeams = [...teams];
                const team = updatedTeams[0];
                const driver = team.drivers[activeDriver];

                // If manual input exists, use it
                if (lapInput) {
                    const lapTime = parseFloat(lapInput);
                    if (isNaN(lapTime) || lapTime <= 0) return;

                    // Check for changeover (3+ minutes since last lap)
                    const isChangeover = lastLapTimeRef.current &&
                                        (Date.now() - lastLapTimeRef.current) > 180000;

                    const delta = lapTime - driver.targetTime;
                    const lapType = calculateLapType(delta, isChangeover);
                    driver.laps.push({
                        number: driver.laps.length + 1,
                        time: lapTime,
                        delta: delta,
                        lapType: lapType,
                        lapValue: calculateLapValue(lapType),
                        timestamp: Date.now()
                    });
                    setTeams(updatedTeams);
                    setLapInput('');
                    lastLapTimeRef.current = Date.now();
                    return;
                }

                // If no manual input, handle stopwatch lap behavior
                if (!isRunning) {
                    // First press: start stopwatch
                    startStopwatch();
                    lastLapTimeRef.current = Date.now();
                } else {
                    // Subsequent press: record lap and restart
                    const lapTime = elapsedTime;

                    // Check for changeover (3+ minutes since last lap)
                    const isChangeover = lastLapTimeRef.current &&
                                        (Date.now() - lastLapTimeRef.current) > 180000;

                    const delta = lapTime - driver.targetTime;
                    const lapType = calculateLapType(delta, isChangeover);
                    driver.laps.push({
                        number: driver.laps.length + 1,
                        time: lapTime,
                        delta: delta,
                        lapType: lapType,
                        lapValue: calculateLapValue(lapType),
                        timestamp: Date.now()
                    });
                    setTeams(updatedTeams);
                    lastLapTimeRef.current = Date.now();

                    // Restart stopwatch for next lap
                    startStopwatch();
                }
            };

            const removeLap = (teamIndex, driverIndex, lapIndex) => {
                const updatedTeams = [...teams];
                updatedTeams[teamIndex].drivers[driverIndex].laps.splice(lapIndex, 1);
                updatedTeams[teamIndex].drivers[driverIndex].laps.forEach((lap, idx) => {
                    lap.number = idx + 1;
                });
                setTeams(updatedTeams);
            };

            const updateLapTime = (teamIndex, driverIndex, lapIndex, newTime) => {
                const updatedTeams = [...teams];
                const driver = updatedTeams[teamIndex].drivers[driverIndex];
                const lap = driver.laps[lapIndex];

                const timeValue = parseTimeInput(newTime);
                if (timeValue === null || isNaN(timeValue) || timeValue <= 0) {
                    alert('Please enter a valid lap time greater than 0 (format: MM:SS.mmm or seconds)');
                    return;
                }

                // Update lap time
                lap.time = timeValue;

                // Recalculate delta and lap type (unless it's a changeover or safety lap)
                if (lap.lapType !== 'changeover' && lap.lapType !== 'safety') {
                    lap.delta = timeValue - driver.targetTime;
                    lap.lapType = calculateLapType(lap.delta, false, false);
                    lap.lapValue = calculateLapValue(lap.lapType);
                }

                setTeams(updatedTeams);
                setEditingLap({ teamIndex: null, driverIndex: null, lapIndex: null, value: '' });
            };

            const clearDriverLaps = (teamIndex, driverIndex) => {
                if (confirm('Are you sure you want to clear all laps for this driver? This cannot be undone.')) {
                    const updatedTeams = [...teams];
                    updatedTeams[teamIndex].drivers[driverIndex].laps = [];
                    setTeams(updatedTeams);

                    // Reset the stopwatch timer
                    resetStopwatch();
                    setShowClearDropdown(false);
                }
            };

            const clearAllDrivers = (teamIndex) => {
                if (confirm('Are you sure you want to clear all laps for ALL drivers? This cannot be undone.')) {
                    const updatedTeams = [...teams];
                    updatedTeams[teamIndex].drivers.forEach(driver => {
                        driver.laps = [];
                    });
                    setTeams(updatedTeams);

                    // Reset the stopwatch timer
                    resetStopwatch();
                    setShowClearDropdown(false);
                }
            };

            const updateDriverName = (teamIndex, driverIndex, name) => {
                const updatedTeams = [...teams];
                updatedTeams[teamIndex].drivers[driverIndex].name = name;
                setTeams(updatedTeams);
            };

            const updateTargetTime = (teamIndex, driverIndex, time) => {
                const updatedTeams = [...teams];
                const newTarget = parseFloat(time);
                const driver = updatedTeams[teamIndex].drivers[driverIndex];
                driver.targetTime = newTarget;
                driver.laps = driver.laps.map(lap => {
                    if (lap.lapType === 'changeover' || lap.lapType === 'safety') return lap; // Don't recalculate changeovers or safety laps
                    const delta = lap.time - newTarget;
                    const lapType = calculateLapType(delta);
                    return {
                        ...lap,
                        delta: delta,
                        lapType: lapType,
                        lapValue: calculateLapValue(lapType)
                    };
                });
                setTeams(updatedTeams);
            };

            const updatePenaltyLaps = (teamIndex, driverIndex, penalty) => {
                const updatedTeams = [...teams];
                updatedTeams[teamIndex].drivers[driverIndex].penaltyLaps = parseInt(penalty) || 0;
                setTeams(updatedTeams);
            };

            const toggleChangeoverLap = (teamIndex, driverIndex, lapIndex) => {
                const updatedTeams = [...teams];
                const lap = updatedTeams[teamIndex].drivers[driverIndex].laps[lapIndex];

                // Toggle between changeover and the original lap type
                if (lap.lapType === 'changeover') {
                    // Revert to original type based on delta
                    const delta = lap.delta;
                    const newLapType = calculateLapType(delta, false, false);
                    lap.lapType = newLapType;
                    lap.lapValue = calculateLapValue(newLapType);
                    setTeams(updatedTeams);
                } else {
                    // Show driver switch modal
                    setChangeoverLapInfo({ teamIndex, driverIndex, lapIndex });
                    setShowDriverSwitch(true);
                }
            };

            const toggleSafetyLap = (teamIndex, driverIndex, lapIndex) => {
                const updatedTeams = [...teams];
                const lap = updatedTeams[teamIndex].drivers[driverIndex].laps[lapIndex];

                // Toggle between safety and the original lap type
                if (lap.lapType === 'safety') {
                    // Revert to original type based on delta
                    const delta = lap.delta;
                    const newLapType = calculateLapType(delta, false, false);
                    lap.lapType = newLapType;
                    lap.lapValue = calculateLapValue(newLapType);
                } else {
                    // Mark as safety car lap (doesn't switch driver)
                    lap.lapType = 'safety';
                    lap.lapValue = 0;
                }
                setTeams(updatedTeams);
            };

            const confirmDriverSwitch = (newDriverIndex) => {
                if (changeoverLapInfo) {
                    const { teamIndex, driverIndex, lapIndex } = changeoverLapInfo;
                    const updatedTeams = [...teams];

                    // Remove the lap from the outgoing driver
                    const lap = updatedTeams[teamIndex].drivers[driverIndex].laps.splice(lapIndex, 1)[0];

                    // Add the lap to the incoming driver (selected in modal)
                    const incomingDriver = updatedTeams[teamIndex].drivers[newDriverIndex];
                    lap.number = incomingDriver.laps.length + 1;
                    lap.lapType = 'changeover';
                    lap.lapValue = 1;
                    incomingDriver.laps.push(lap);

                    // Renumber remaining laps for outgoing driver
                    updatedTeams[teamIndex].drivers[driverIndex].laps.forEach((l, idx) => {
                        l.number = idx + 1;
                    });

                    setTeams(updatedTeams);
                    setActiveDriver(newDriverIndex);
                    setShowDriverSwitch(false);
                    setChangeoverLapInfo(null);

                    // Reset stopwatch for new driver
                    resetStopwatch();
                }
            };

            const addDriver = (teamIndex) => {
                const updatedTeams = [...teams];
                const team = updatedTeams[teamIndex];
                const newDriverId = Math.max(...team.drivers.map(d => d.id), 0) + 1;
                const driverLetter = String.fromCharCode(65 + team.drivers.length); // A, B, C, etc.

                team.drivers.push({
                    id: newDriverId,
                    name: `Driver ${driverLetter}`,
                    targetTime: 102,
                    laps: [],
                    penaltyLaps: 0
                });

                setTeams(updatedTeams);
            };

            const removeDriver = (teamIndex, driverIndex) => {
                const updatedTeams = [...teams];
                const team = updatedTeams[teamIndex];

                if (team.drivers.length <= 1) {
                    alert('Cannot remove the last driver from a team.');
                    return;
                }

                if (team.drivers[driverIndex].laps.length > 0) {
                    if (!confirm('This driver has recorded laps. Are you sure you want to remove them?')) {
                        return;
                    }
                }

                team.drivers.splice(driverIndex, 1);

                // Adjust active driver if necessary
                if (activeDriver >= team.drivers.length) {
                    setActiveDriver(team.drivers.length - 1);
                }

                setTeams(updatedTeams);
            };

            const addTeam = () => {
                const newTeamId = Math.max(...teams.map(t => t.id), 0) + 1;
                const newTeam = {
                    id: newTeamId,
                    name: `Team ${newTeamId}`,
                    drivers: [
                        { id: 1, name: 'Driver A', targetTime: 102, laps: [], penaltyLaps: 0 }
                    ]
                };
                setTeams([...teams, newTeam]);
                setActiveTeam(teams.length);
                setActiveDriver(0);
            };

            const removeTeam = (teamIndex) => {
                if (teams.length <= 1) {
                    alert('Cannot remove the last team.');
                    return;
                }

                const team = teams[teamIndex];
                const hasLaps = team.drivers.some(d => d.laps.length > 0);

                if (hasLaps) {
                    if (!confirm('This team has recorded laps. Are you sure you want to remove it?')) {
                        return;
                    }
                }

                const updatedTeams = [...teams];
                updatedTeams.splice(teamIndex, 1);
                setTeams(updatedTeams);

                // Adjust active team if necessary
                if (activeTeam >= updatedTeams.length) {
                    setActiveTeam(updatedTeams.length - 1);
                }
                setActiveDriver(0);
            };

            const updateTeamName = (teamIndex, name) => {
                const updatedTeams = [...teams];
                updatedTeams[teamIndex].name = name;
                setTeams(updatedTeams);
            };

            // WINTON SCORING CALCULATIONS

            // Get driver's base laps (total laps run including all types)
            const getDriverBaseLaps = (driver) => {
                return driver.laps.length;
            };

            // Get driver's changeover laps
            const getDriverChangeoverLaps = (driver) => {
                return driver.laps.filter(lap => lap.lapType === 'changeover').length;
            };

            // Get driver's bonus laps
            const getDriverBonusLaps = (driver) => {
                return driver.laps.filter(lap => lap.lapType === 'bonus').length;
            };

            // Get driver's broken laps
            const getDriverBrokenLaps = (driver) => {
                return driver.laps.filter(lap => lap.lapType === 'broken').length;
            };

            // Get driver's achieved laps (sum of all lapValues - Penalty)
            const getDriverAchievedLaps = (driver) => {
                const totalLapValue = driver.laps.reduce((sum, lap) => sum + (lap.lapValue || 0), 0);
                return totalLapValue - driver.penaltyLaps;
            };

            // Get driver's 3-lap rolling average delta (excluding changeover and safety car laps)
            const getDriver3LapAverage = (driver) => {
                const regularLaps = driver.laps.filter(lap => lap.lapType !== 'changeover' && lap.lapType !== 'safety');
                if (regularLaps.length === 0) return null;

                const lastThree = regularLaps.slice(-3);
                const sum = lastThree.reduce((total, lap) => total + lap.delta, 0);
                return sum / lastThree.length;
            };

            // Get 3-lap average at a specific lap index (for historical signal display)
            const get3LapAverageAtIndex = (driver, lapIndex) => {
                const regularLaps = driver.laps
                    .slice(0, lapIndex + 1)
                    .filter(lap => lap.lapType !== 'changeover' && lap.lapType !== 'safety');

                if (regularLaps.length === 0) return null;

                const lastThree = regularLaps.slice(-3);
                const sum = lastThree.reduce((total, lap) => total + lap.delta, 0);
                return sum / lastThree.length;
            };

            // Get last 3 regular laps at a specific index (for signal calculation)
            const getLast3RegularLapsAtIndex = (driver, lapIndex) => {
                const regularLaps = driver.laps
                    .slice(0, lapIndex + 1)
                    .filter(lap => lap.lapType !== 'changeover' && lap.lapType !== 'safety');
                return regularLaps.slice(-3);
            };

            // Get signal color based on 3-lap average delta and previous lap type
            const getSignalColor = (avg, previousLapType = null) => {
                if (avg === null) return null;

                // Red if previous lap was broken
                if (previousLapType === 'broken') return 'bg-red-500';

                // Simple delta-based thresholds
                if (avg >= 0.3 && avg < 1.0) return 'bg-green-500';  // Optimal bonus lap territory (0.3-0.99s)
                if (avg < 0.3) return 'bg-red-500';  // Too fast or too close - need to slow down (negative to 0.29s)
                return 'bg-blue-500';  // Too slow (>=1.0s)
            };

            // Get signal color for current driver
            const getDriverSignalColor = (driver) => {
                const avg = getDriver3LapAverage(driver);
                const regularLaps = driver.laps.filter(lap => lap.lapType !== 'changeover' && lap.lapType !== 'safety');
                const previousLap = regularLaps.length > 0 ? regularLaps[regularLaps.length - 1] : null;
                return getSignalColor(avg, previousLap?.lapType);
            };

            // Get team's total base and changeover laps
            const getTeamBaseAndChangeoverLaps = (team) => {
                return team.drivers.reduce((total, driver) => {
                    return total + getDriverBaseLaps(driver) + getDriverChangeoverLaps(driver);
                }, 0);
            };

            // Calculate driver's goal laps based on Winton formula
            const calculateDriverGoalLaps = (driver, team) => {
                const teamTotal = getTeamBaseAndChangeoverLaps(team);
                if (teamTotal === 0) return 0;

                const driverTotal = getDriverBaseLaps(driver) + getDriverChangeoverLaps(driver);
                const percentage = driverTotal / teamTotal;

                // Formula: (percentage * sessionDuration * 60) / driver's target time * 2 (to consider bonus laps)
                const sessionDurationSeconds = (team.sessionDuration || 120) * 60;
                const theoreticalMax = (percentage * sessionDurationSeconds) / driver.targetTime;
                return theoreticalMax * 2; // Doubled to consider bonus laps
            };

            // Get team's total goal laps
            const getTeamGoalLaps = (team) => {
                return team.drivers.reduce((total, driver) => {
                    return total + calculateDriverGoalLaps(driver, team);
                }, 0);
            };

            // Get team's total achieved laps
            const getTeamAchievedLaps = (team) => {
                return team.drivers.reduce((total, driver) => {
                    return total + getDriverAchievedLaps(driver);
                }, 0);
            };

            // Calculate team's percentage factor
            const getTeamPercentageFactor = (team) => {
                const goalLaps = getTeamGoalLaps(team);
                if (goalLaps === 0) return 0;
                const achievedLaps = getTeamAchievedLaps(team);
                return (achievedLaps / goalLaps * 100).toFixed(4);
            };

            const getCurrentStatus = (driver) => {
                if (driver.laps.length === 0) return { signal: 'WAITING', color: 'bg-gray-500', message: 'No laps yet' };

                const lastLap = driver.laps[driver.laps.length - 1];
                const delta = lastLap.delta;
                const lapType = lastLap.lapType;

                if (lapType === 'changeover') {
                    return { signal: 'CHANGEOVER', color: 'bg-purple-500', message: 'Driver change' };
                } else if (lapType === 'bonus') {
                    return { signal: 'BONUS LAP!', color: 'bg-green-500', message: `+2 Laps ${!isNaN(delta) ? `(${delta > 0 ? '+' : ''}${delta.toFixed(2)}s)` : ''}` };
                } else if (lapType === 'base') {
                    return { signal: 'BASE LAP', color: 'bg-blue-500', message: `+1 Lap ${!isNaN(delta) ? `(${delta > 0 ? '+' : ''}${delta.toFixed(2)}s)` : ''}` };
                } else {
                    return { signal: 'BROKEN!', color: 'bg-red-500', message: `Wasted lap! ${!isNaN(delta) ? `(${delta.toFixed(2)}s)` : ''}` };
                }
            };

            const getAverageDelta = (driver, excludeOutliers = false) => {
                if (driver.laps.length === 0) return 0;

                if (!excludeOutliers) {
                    const sum = driver.laps.reduce((acc, lap) => acc + lap.delta, 0);
                    return sum / driver.laps.length;
                }

                // For PDFs, exclude highest and lowest delta values
                if (driver.laps.length <= 2) {
                    // Not enough laps to exclude outliers
                    const sum = driver.laps.reduce((acc, lap) => acc + lap.delta, 0);
                    return sum / driver.laps.length;
                }

                const deltas = driver.laps.map(lap => lap.delta).sort((a, b) => a - b);
                // Remove first (lowest) and last (highest)
                const filteredDeltas = deltas.slice(1, -1);
                const sum = filteredDeltas.reduce((acc, delta) => acc + delta, 0);
                return sum / filteredDeltas.length;
            };

            // Audio beep functionality
            const playBeep = (doubleBeep = false) => {
                if (!audioSettings.enabled) return; // Check if audio is enabled

                const audioContext = new (window.AudioContext || window.webkitAudioContext)();

                // Play first beep
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();

                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);

                oscillator.frequency.value = 800; // Frequency in Hz
                oscillator.type = 'sine';

                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.2);

                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.2);

                // Play second beep if doubleBeep is true - use same AudioContext
                if (doubleBeep) {
                    const oscillator2 = audioContext.createOscillator();
                    const gainNode2 = audioContext.createGain();

                    oscillator2.connect(gainNode2);
                    gainNode2.connect(audioContext.destination);

                    oscillator2.frequency.value = 800;
                    oscillator2.type = 'sine';

                    const startTime = audioContext.currentTime + 0.25;
                    gainNode2.gain.setValueAtTime(0.3, startTime);
                    gainNode2.gain.exponentialRampToValueAtTime(0.01, startTime + 0.2);

                    oscillator2.start(startTime);
                    oscillator2.stop(startTime + 0.2);
                }
            };

            // Helper function to calculate linear regression trend line
            const calculateTrendLine = (data) => {
                const n = data.length;
                if (n === 0) return [];

                const sumX = data.reduce((sum, _, i) => sum + i, 0);
                const sumY = data.reduce((sum, val) => sum + val, 0);
                const sumXY = data.reduce((sum, val, i) => sum + (i * val), 0);
                const sumX2 = data.reduce((sum, _, i) => sum + (i * i), 0);

                const slope = (n * sumXY - sumX * sumY) / (n * sumX2 - sumX * sumX);
                const intercept = (sumY - slope * sumX) / n;

                return data.map((_, i) => slope * i + intercept);
            };

            // Helper function to generate chart image
            const generateChartImage = (driver, chartType) => {
                return new Promise((resolve) => {
                    const canvas = document.createElement('canvas');
                    canvas.width = 600;
                    canvas.height = 240;
                    const ctx = canvas.getContext('2d');

                    // Plugin to add white background
                    const whiteBackgroundPlugin = {
                        id: 'whiteBackground',
                        beforeDraw: (chart) => {
                            const ctx = chart.canvas.getContext('2d');
                            ctx.save();
                            ctx.globalCompositeOperation = 'destination-over';
                            ctx.fillStyle = '#ffffff';
                            ctx.fillRect(0, 0, chart.width, chart.height);
                            ctx.restore();
                        }
                    };

                    // Plugin to add colored zones for bonus/broken laps (for lap times chart)
                    const coloredZonesPlugin = {
                        id: 'coloredZones',
                        beforeDatasetsDraw: (chart) => {
                            const ctx = chart.canvas.getContext('2d');
                            const chartArea = chart.chartArea;
                            const yScale = chart.scales.y;

                            if (!chartArea || !yScale) return;

                            const targetTime = driver.targetTime;
                            const bonusThreshold = targetTime + 0.99; // Bonus zone: target to target + 0.99s

                            ctx.save();

                            // Draw green zone (Bonus: target to target + 0.99s)
                            const bonusTop = yScale.getPixelForValue(targetTime);
                            const bonusBottom = yScale.getPixelForValue(bonusThreshold);
                            ctx.fillStyle = 'rgba(34, 197, 94, 0.15)'; // Light green
                            ctx.fillRect(chartArea.left, bonusTop, chartArea.right - chartArea.left, bonusBottom - bonusTop);

                            // Draw blue zone (Base: target + 0.99s to max)
                            const baseTop = yScale.getPixelForValue(bonusThreshold);
                            const baseBottom = yScale.getPixelForValue(Math.max(...yScale.ticks.map(t => t.value)));
                            ctx.fillStyle = 'rgba(59, 130, 246, 0.1)'; // Light blue
                            ctx.fillRect(chartArea.left, baseTop, chartArea.right - chartArea.left, baseBottom - baseTop);

                            // Draw red zone (Broken: below target)
                            const brokenTop = yScale.getPixelForValue(Math.min(...yScale.ticks.map(t => t.value)));
                            const brokenBottom = yScale.getPixelForValue(targetTime);
                            ctx.fillStyle = 'rgba(239, 68, 68, 0.15)'; // Light red
                            ctx.fillRect(chartArea.left, brokenBottom, chartArea.right - chartArea.left, brokenTop - brokenBottom);

                            ctx.restore();
                        }
                    };

                    // Plugin to add colored zones for delta chart
                    const deltaZonesPlugin = {
                        id: 'deltaZones',
                        beforeDatasetsDraw: (chart) => {
                            const ctx = chart.canvas.getContext('2d');
                            const chartArea = chart.chartArea;
                            const yScale = chart.scales.y;

                            if (!chartArea || !yScale) return;

                            ctx.save();

                            // Draw green zone (Bonus: 0 to +0.99s delta)
                            const bonusTop = yScale.getPixelForValue(0);
                            const bonusBottom = yScale.getPixelForValue(0.99);
                            ctx.fillStyle = 'rgba(34, 197, 94, 0.15)'; // Light green
                            ctx.fillRect(chartArea.left, bonusTop, chartArea.right - chartArea.left, bonusBottom - bonusTop);

                            // Draw blue zone (Base: +0.99s to max)
                            const baseTop = yScale.getPixelForValue(0.99);
                            const baseBottom = yScale.getPixelForValue(Math.max(...yScale.ticks.map(t => t.value)));
                            ctx.fillStyle = 'rgba(59, 130, 246, 0.1)'; // Light blue
                            ctx.fillRect(chartArea.left, baseTop, chartArea.right - chartArea.left, baseBottom - baseTop);

                            // Draw red zone (Broken: negative delta)
                            const brokenTop = yScale.getPixelForValue(Math.min(...yScale.ticks.map(t => t.value)));
                            const brokenBottom = yScale.getPixelForValue(0);
                            ctx.fillStyle = 'rgba(239, 68, 68, 0.15)'; // Light red
                            ctx.fillRect(chartArea.left, brokenBottom, chartArea.right - chartArea.left, brokenTop - brokenBottom);

                            ctx.restore();
                        }
                    };

                    if (chartType === 'lapTimes') {
                        const lapTimes = driver.laps.map(lap => lap.time);
                        const trendLine = calculateTrendLine(lapTimes);

                        new Chart(ctx, {
                            type: 'line',
                            data: {
                                labels: driver.laps.map(lap => `${lap.number}`),
                                datasets: [{
                                    label: 'Lap Time',
                                    data: lapTimes,
                                    borderColor: '#3b82f6',
                                    backgroundColor: 'rgba(59, 130, 246, 0.1)',
                                    tension: 0.1,
                                    fill: true
                                }, {
                                    label: 'Target',
                                    data: driver.laps.map(() => driver.targetTime),
                                    borderColor: '#ef4444',
                                    borderDash: [5, 5],
                                    pointRadius: 0,
                                    fill: false
                                }, {
                                    label: 'Trend',
                                    data: trendLine,
                                    borderColor: '#22c55e',
                                    borderWidth: 2,
                                    borderDash: [10, 5],
                                    pointRadius: 0,
                                    fill: false
                                }]
                            },
                            options: {
                                responsive: false,
                                animation: { duration: 0 },
                                plugins: {
                                    legend: { labels: { font: { size: 12 } } }
                                },
                                scales: {
                                    x: {
                                        title: { display: true, text: 'Lap Number' },
                                        ticks: { maxRotation: 0 }
                                    },
                                    y: {
                                        title: { display: true, text: 'Time (s)' }
                                    }
                                }
                            },
                            plugins: [whiteBackgroundPlugin, coloredZonesPlugin]
                        });
                    } else if (chartType === 'delta') {
                        const nonChangeoverLaps = driver.laps.filter(lap => lap.lapType !== 'changeover' && lap.lapType !== 'safety');
                        const deltas = nonChangeoverLaps.map(lap => lap.delta);
                        const trendLine = calculateTrendLine(deltas);

                        new Chart(ctx, {
                            type: 'bar',
                            data: {
                                labels: nonChangeoverLaps.map(lap => `${lap.number}`),
                                datasets: [{
                                    label: 'Delta',
                                    data: deltas,
                                    backgroundColor: nonChangeoverLaps.map(lap => {
                                        if (lap.lapType === 'bonus') return 'rgba(34, 197, 94, 0.6)';
                                        if (lap.lapType === 'broken') return 'rgba(239, 68, 68, 0.6)';
                                        return 'rgba(59, 130, 246, 0.6)';
                                    }),
                                    order: 2
                                }, {
                                    label: 'Trend',
                                    data: trendLine,
                                    type: 'line',
                                    borderColor: '#22c55e',
                                    borderWidth: 2,
                                    borderDash: [10, 5],
                                    pointRadius: 0,
                                    fill: false,
                                    order: 1
                                }]
                            },
                            options: {
                                responsive: false,
                                animation: { duration: 0 },
                                plugins: {
                                    legend: { labels: { font: { size: 12 } } }
                                },
                                scales: {
                                    x: {
                                        title: { display: true, text: 'Lap Number' },
                                        ticks: { maxRotation: 0 }
                                    },
                                    y: {
                                        title: { display: true, text: 'Delta (s)' }
                                    }
                                }
                            },
                            plugins: [whiteBackgroundPlugin, deltaZonesPlugin]
                        });
                    }

                    setTimeout(() => {
                        resolve(canvas.toDataURL('image/jpeg', 0.7));
                    }, 100);
                });
            };

            const generatePDF = async () => {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();

                const team = teams[0];
                const goalLaps = getTeamGoalLaps(team);
                const achievedLaps = getTeamAchievedLaps(team);
                const percentageFactor = getTeamPercentageFactor(team);

                // Title
                doc.setFontSize(20);
                doc.setTextColor(30, 64, 175);
                doc.text(`${team.name} Race Report`, 20, 20);

                doc.setFontSize(10);
                doc.setTextColor(0, 0, 0);
                let yPos = 28;
                if (team.raceName) {
                    doc.text(`Race: ${team.raceName}`, 20, yPos);
                    yPos += 6;
                }
                if (team.sessionNumber) {
                    doc.text(`Session #: ${team.sessionNumber}`, 20, yPos);
                    yPos += 6;
                }
                if (team.sessionDuration) {
                    doc.text(`Session Duration: ${team.sessionDuration} mins`, 20, yPos);
                    yPos += 6;
                }
                doc.text(`Generated: ${new Date().toLocaleString()}`, 20, yPos);

                // Team Summary
                doc.setFontSize(12);
                doc.setTextColor(0, 0, 0);
                yPos += 12;
                doc.text(`Goal Laps: ${goalLaps.toFixed(2)}`, 20, yPos);
                doc.text(`Achieved Laps: ${achievedLaps}`, 20, yPos + 7);
                doc.text(`Percentage Factor: ${percentageFactor}%`, 20, yPos + 14);

                // Driver Summary Table
                const teamTotal = getTeamBaseAndChangeoverLaps(team);
                const driverData = team.drivers.map(d => {
                    const driverTotal = getDriverBaseLaps(d) + getDriverChangeoverLaps(d);
                    const percentage = teamTotal === 0 ? 0 : (driverTotal / teamTotal) * 100;
                    const avgLapTime = d.laps.length > 0 ? d.laps.reduce((sum, lap) => sum + lap.time, 0) / d.laps.length : 0;
                    const netScore = getDriverBonusLaps(d) - getDriverBrokenLaps(d);
                    return [
                        d.name,
                        formatTime(d.targetTime),
                        formatTime(avgLapTime),
                        getDriverAchievedLaps(d),
                        netScore,
                        getDriverBaseLaps(d),
                        getDriverBonusLaps(d),
                        getDriverChangeoverLaps(d),
                        getDriverBrokenLaps(d),
                        d.penaltyLaps,
                        calculateDriverGoalLaps(d, team).toFixed(2)
                    ];
                });

                // Add totals row
                const totalNetScore = team.drivers.reduce((sum, d) => sum + (getDriverBonusLaps(d) - getDriverBrokenLaps(d)), 0);
                driverData.push([
                    'TOTAL',
                    '',
                    '',
                    achievedLaps,
                    totalNetScore,
                    team.drivers.reduce((sum, d) => sum + getDriverBaseLaps(d), 0),
                    team.drivers.reduce((sum, d) => sum + getDriverBonusLaps(d), 0),
                    team.drivers.reduce((sum, d) => sum + getDriverChangeoverLaps(d), 0),
                    team.drivers.reduce((sum, d) => sum + getDriverBrokenLaps(d), 0),
                    team.drivers.reduce((sum, d) => sum + d.penaltyLaps, 0),
                    goalLaps.toFixed(2)
                ]);

                doc.autoTable({
                    startY: yPos + 20,
                    head: [['Driver', 'Target', 'Avg Time', 'Achieved', 'Net', 'Base', 'Bonus', 'C/O', 'Broken', 'Penalty', 'Goal']],
                    body: driverData,
                    theme: 'striped',
                    headStyles: { fillColor: [30, 64, 175] },
                    styles: { fontSize: 8 }
                });

                // Individual Driver Details
                for (const driver of team.drivers) {
                    // Add page break for each driver
                    doc.addPage();

                    doc.setFontSize(14);
                    doc.setTextColor(30, 64, 175);
                    doc.text(`${driver.name} - Detailed Lap Times`, 20, 20);

                    const lapData = driver.laps.map(lap => [
                        lap.number,
                        formatTime(lap.time),
                        formatTime(driver.targetTime),
                        lap.lapType === 'changeover' ? '*****' : `${lap.delta > 0 ? '+' : ''}${formatTime(Math.abs(lap.delta))}`,
                        lap.lapType === 'bonus' ? 'Bonus (+2)' :
                        lap.lapType === 'broken' ? 'Broken (0)' :
                        lap.lapType === 'changeover' ? 'Changeover (+1)' : 'Base (+1)'
                    ]);

                    if (lapData.length === 0) {
                        doc.setFontSize(10);
                        doc.setTextColor(100, 100, 100);
                        doc.text('No laps recorded', 20, 30);
                    } else {
                        doc.autoTable({
                            startY: 27,
                            head: [['Lap #', 'Time', 'Target', 'Delta', 'Type']],
                            body: lapData,
                            theme: 'striped',
                            headStyles: { fillColor: [30, 64, 175] },
                            styles: { fontSize: 8 },
                            margin: { left: 20, right: 20 }
                        });

                        // Add charts for this driver
                        doc.addPage();

                        // Lap Times Chart
                        doc.setFontSize(14);
                        doc.setTextColor(30, 64, 175);
                        doc.text(`${driver.name} - Lap Times Over Time`, 20, 20);

                        const lapTimesImg = await generateChartImage(driver, 'lapTimes');
                        doc.addImage(lapTimesImg, 'JPEG', 15, 30, 180, 72);

                        // Delta Chart
                        doc.setFontSize(14);
                        doc.setTextColor(30, 64, 175);
                        doc.text(`${driver.name} - Delta from Target`, 20, 115);

                        const deltaImg = await generateChartImage(driver, 'delta');
                        doc.addImage(deltaImg, 'JPEG', 15, 125, 180, 72);
                    }
                }

                // Footer
                const pageCount = doc.internal.getNumberOfPages();
                for (let i = 1; i <= pageCount; i++) {
                    doc.setPage(i);
                    doc.setFontSize(8);
                    doc.setTextColor(150, 150, 150);
                    doc.text(`${team.name} Race Timer`, 105, 285, { align: 'center' });
                    doc.text(`Page ${i} of ${pageCount}`, 105, 290, { align: 'center' });
                }

                const raceName = team.raceName ? `${team.raceName.replace(/\s+/g, '-')}-` : '';
                const sessionNumber = team.sessionNumber ? `Session-${team.sessionNumber}-` : '';
                doc.save(`${raceName}${team.name.replace(/\s+/g, '-')}-${sessionNumber}${new Date().toISOString().split('T')[0]}.pdf`);
            };

            const generatePDFOld = () => {
                const currentTeam = teams[activeTeam];
                const goalLaps = getTeamGoalLaps(currentTeam);
                const achievedLaps = getTeamAchievedLaps(currentTeam);
                const percentageFactor = getTeamPercentageFactor(currentTeam);

                let htmlContent = `
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <meta charset="utf-8">
                        <title>Regularity Race Report</title>
                        <style>
                            body { font-family: Arial, sans-serif; margin: 40px; color: #333; }
                            h1 { color: #1e40af; border-bottom: 3px solid #1e40af; padding-bottom: 10px; }
                            h2 { color: #1e40af; margin-top: 30px; border-bottom: 2px solid #ddd; padding-bottom: 5px; }
                            table { width: 100%; border-collapse: collapse; margin: 20px 0; page-break-inside: avoid; }
                            th, td { border: 1px solid #ddd; padding: 12px; text-align: left; }
                            th { background-color: #1e40af; color: white; font-weight: bold; }
                            tr:nth-child(even) { background-color: #f9f9f9; }
                            .stats { background-color: #f0f0f0; padding: 15px; border-radius: 5px; margin: 15px 0; }
                            .stats-row { display: flex; justify-content: space-between; margin: 5px 0; }
                            .bonus { color: #16a34a; font-weight: bold; }
                            .broken { color: #dc2626; font-weight: bold; }
                            .base { color: #2563eb; font-weight: bold; }
                            .changeover { color: #9333ea; font-weight: bold; }
                            .driver-section { page-break-after: always; }
                            .driver-section:last-child { page-break-after: auto; }
                            .footer { margin-top: 30px; text-align: center; color: #666; font-size: 12px; }
                            .team-summary { background-color: #e0f2fe; padding: 20px; border-radius: 5px; margin: 20px 0; }
                            .highlight { font-size: 24px; font-weight: bold; color: #1e40af; }
                        </style>
                    </head>
                    <body>
                        <h1> ${currentTeam.name} Race Report</h1>
                        <p><strong>Generated:</strong> ${new Date().toLocaleString()}</p>

                        <div class="team-summary">
                            <h2>${currentTeam.name}</h2>
                            <div class="stats-row">
                                <span><strong>Goal Laps:</strong></span>
                                <span class="highlight">${goalLaps.toFixed(2)}</span>
                            </div>
                            <div class="stats-row">
                                <span><strong>Achieved Laps:</strong></span>
                                <span class="highlight bonus">${achievedLaps}</span>
                            </div>
                            <div class="stats-row">
                                <span><strong>Percentage Factor:</strong></span>
                                <span class="highlight">${percentageFactor}%</span>
                            </div>
                        </div>

                        <table>
                            <thead>
                                <tr>
                                    <th>Driver</th>
                                    <th>Target</th>
                                    <th>Base</th>
                                    <th>Bonus</th>
                                    <th>Changeover</th>
                                    <th>Broken</th>
                                    <th>Penalty</th>
                                    <th>Achieved</th>
                                    <th>Goal</th>
                                </tr>
                            </thead>
                            <tbody>
                `;

                currentTeam.drivers.forEach(d => {
                    htmlContent += `
                        <tr>
                            <td><strong>${d.name}</strong></td>
                            <td>${d.targetTime}s</td>
                            <td>${getDriverBaseLaps(d)}</td>
                            <td class="bonus">${getDriverBonusLaps(d)}</td>
                            <td class="changeover">${getDriverChangeoverLaps(d)}</td>
                            <td class="broken">${getDriverBrokenLaps(d)}</td>
                            <td class="broken">${d.penaltyLaps}</td>
                            <td class="bonus"><strong>${getDriverAchievedLaps(d)}</strong></td>
                            <td>${calculateDriverGoalLaps(d, currentTeam).toFixed(2)}</td>
                        </tr>
                    `;
                });

                htmlContent += `
                                <tr style="font-weight: bold; background-color: #e0f2fe;">
                                    <td>TOTAL</td>
                                    <td></td>
                                    <td>${currentTeam.drivers.reduce((sum, d) => sum + getDriverBaseLaps(d), 0)}</td>
                                    <td class="bonus">${currentTeam.drivers.reduce((sum, d) => sum + getDriverBonusLaps(d), 0)}</td>
                                    <td class="changeover">${currentTeam.drivers.reduce((sum, d) => sum + getDriverChangeoverLaps(d), 0)}</td>
                                    <td class="broken">${currentTeam.drivers.reduce((sum, d) => sum + getDriverBrokenLaps(d), 0)}</td>
                                    <td class="broken">${currentTeam.drivers.reduce((sum, d) => sum + d.penaltyLaps, 0)}</td>
                                    <td class="bonus"><strong>${achievedLaps}</strong></td>
                                    <td>${goalLaps.toFixed(2)}</td>
                                </tr>
                            </tbody>
                        </table>
                `;

                // Individual driver details
                currentTeam.drivers.forEach((driver, idx) => {
                    const avgDelta = getAverageDelta(driver, true);
                    const totalTime = driver.laps.reduce((acc, lap) => acc + lap.time, 0);
                    const bestLap = driver.laps.length > 0 ? Math.min(...driver.laps.map(l => Math.abs(l.delta))) : 0;
                    const worstLap = driver.laps.length > 0 ? Math.max(...driver.laps.map(l => Math.abs(l.delta))) : 0;

                    htmlContent += `
                        <div class="driver-section">
                            <h2>${driver.name} - Detailed Lap Times</h2>
                            <div class="stats">
                                <div class="stats-row">
                                    <span><strong>Target Lap Time:</strong></span>
                                    <span>${driver.targetTime.toFixed(2)}s</span>
                                </div>
                                <div class="stats-row">
                                    <span><strong>Total Laps Run:</strong></span>
                                    <span>${driver.laps.length}</span>
                                </div>
                                <div class="stats-row">
                                    <span><strong>Achieved Laps:</strong></span>
                                    <span class="bonus">${getDriverAchievedLaps(driver)}</span>
                                </div>
                                <div class="stats-row">
                                    <span><strong>Goal Laps:</strong></span>
                                    <span>${calculateDriverGoalLaps(driver, currentTeam).toFixed(2)}</span>
                                </div>
                                <div class="stats-row">
                                    <span><strong>Average Delta:</strong></span>
                                    <span class="${avgDelta > 0.99 ? 'base' : avgDelta < 0 ? 'broken' : 'bonus'}">
                                        ${avgDelta > 0 ? '+' : ''}${avgDelta.toFixed(2)}s
                                    </span>
                                </div>
                                <div class="stats-row">
                                    <span><strong>Total Time:</strong></span>
                                    <span>${totalTime.toFixed(2)}s</span>
                                </div>
                                <div class="stats-row">
                                    <span><strong>Best Consistency:</strong></span>
                                    <span>${bestLap.toFixed(2)}s variance</span>
                                </div>
                                <div class="stats-row">
                                    <span><strong>Worst Consistency:</strong></span>
                                    <span>${worstLap.toFixed(2)}s variance</span>
                                </div>
                            </div>
                            <table>
                                <thead>
                                    <tr>
                                        <th>Lap #</th>
                                        <th>Time</th>
                                        <th>Target</th>
                                        <th>Delta</th>
                                        <th>Type</th>
                                    </tr>
                                </thead>
                                <tbody>
                    `;

                    if (driver.laps.length === 0) {
                        htmlContent += `<tr><td colspan="5" style="text-align: center; color: #999;">No laps recorded</td></tr>`;
                    } else {
                        driver.laps.forEach(lap => {
                            const statusClass = lap.lapType === 'bonus' ? 'bonus' :
                                              lap.lapType === 'broken' ? 'broken' :
                                              lap.lapType === 'changeover' ? 'changeover' : 'base';
                            const statusText = lap.lapType === 'bonus' ? 'Bonus (+2)' :
                                             lap.lapType === 'broken' ? 'Broken (0)' :
                                             lap.lapType === 'changeover' ? 'Changeover (+1)' : 'Base (+1)';

                            htmlContent += `
                                <tr>
                                    <td>${lap.number}</td>
                                    <td>${formatTime(lap.time)}</td>
                                    <td>${formatTime(driver.targetTime)}</td>
                                    <td class="${statusClass}">${lap.lapType === 'changeover' ? '*****' : (lap.delta > 0 ? '+' : '') + formatTime(Math.abs(lap.delta))}</td>
                                    <td class="${statusClass}">${statusText}</td>
                                </tr>
                            `;
                        });
                    }

                    htmlContent += `
                                </tbody>
                            </table>
                        </div>
                    `;
                });

                htmlContent += `
                        <div class="footer">
                            <p>${currentTeam.name} Race Timer Report</p>
                            <p>${currentTeam.name} Scoring System: Bonus (+0.99s) = 2 laps | Base (>+0.99s) = 1 lap | Broken (<0s) = 0 laps</p>
                        </div>
                    </body>
                    </html>
                `;

                const blob = new Blob([htmlContent], { type: 'text/html' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `${currentTeam.name.replace(/\s+/g, '-')}-race-report-${new Date().toISOString().split('T')[0]}.html`;
                link.click();
                URL.revokeObjectURL(url);

                alert('Report downloaded! Open the HTML file in your browser and use Print > Save as PDF to create a PDF.');
            };

            const generateDriverPDF = async (teamIndex, driverIndex) => {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();

                const currentTeam = teams[teamIndex];
                const driver = currentTeam.drivers[driverIndex];
                const avgDelta = getAverageDelta(driver, true);
                const totalTime = driver.laps.reduce((acc, lap) => acc + lap.time, 0);
                const avgLapTime = driver.laps.length > 0 ? totalTime / driver.laps.length : 0;
                const bestLap = driver.laps.length > 0 ? Math.min(...driver.laps.map(l => Math.abs(l.delta))) : 0;
                const worstLap = driver.laps.length > 0 ? Math.max(...driver.laps.map(l => Math.abs(l.delta))) : 0;

                // Title
                doc.setFontSize(20);
                doc.setTextColor(30, 64, 175);
                doc.text(`${driver.name} - Race Report`, 20, 20);

                doc.setFontSize(10);
                doc.setTextColor(0, 0, 0);
                let yPos = 28;
                doc.text(`Team: ${currentTeam.name}`, 20, yPos);
                yPos += 6;
                if (currentTeam.raceName) {
                    doc.text(`Race: ${currentTeam.raceName}`, 20, yPos);
                    yPos += 6;
                }
                if (currentTeam.sessionNumber && currentTeam.sessionNumber.trim() !== '') {
                    doc.text(`Session #: ${currentTeam.sessionNumber}`, 20, yPos);
                    yPos += 6;
                }
                if (currentTeam.sessionDuration) {
                    doc.text(`Session Duration: ${currentTeam.sessionDuration} mins`, 20, yPos);
                    yPos += 6;
                }
                doc.text(`Generated: ${new Date().toLocaleString()}`, 20, yPos);

                // Key Stats
                doc.setFontSize(14);
                doc.setTextColor(30, 64, 175);
                doc.text('Summary', 20, yPos + 11);

                doc.setFontSize(11);
                doc.setTextColor(0, 0, 0);
                let statsY = yPos + 19;
                doc.text(`Target Lap Time: ${formatTime(driver.targetTime)}`, 20, statsY);
                doc.text(`Avg Lap Time: ${formatTime(avgLapTime)}`, 20, statsY + 7);
                doc.text(`Total Laps Run: ${driver.laps.length}`, 20, statsY + 14);
                doc.text(`Achieved Laps: ${getDriverAchievedLaps(driver)}`, 20, statsY + 21);
                doc.text(`Net Score: ${getDriverBonusLaps(driver) - getDriverBrokenLaps(driver)}`, 20, statsY + 28);
                doc.text(`Goal Laps: ${calculateDriverGoalLaps(driver, currentTeam).toFixed(2)}`, 20, statsY + 35);

                // Performance Stats
                doc.setFontSize(14);
                doc.setTextColor(30, 64, 175);
                doc.text('Performance', 110, yPos + 11);

                doc.setFontSize(11);
                doc.setTextColor(0, 0, 0);
                doc.text(`Base Laps: ${getDriverBaseLaps(driver)}`, 110, statsY);
                doc.text(`Bonus Laps: ${getDriverBonusLaps(driver)}`, 110, statsY + 7);
                doc.text(`Changeover: ${getDriverChangeoverLaps(driver)}`, 110, statsY + 14);
                doc.text(`Broken Laps: ${getDriverBrokenLaps(driver)}`, 110, statsY + 21);
                doc.text(`Penalty Laps: ${driver.penaltyLaps}`, 110, statsY + 28);
                doc.text(`Avg Delta: ${avgDelta > 0 ? '+' : ''}${formatTime(Math.abs(avgDelta))}`, 110, statsY + 35);
                doc.text(`Best Consistency: ${formatTime(bestLap)}`, 110, statsY + 42);
                doc.text(`Worst Consistency: ${formatTime(worstLap)}`, 110, statsY + 49);

                // Lap Details Table
                const lapData = driver.laps.map(lap => [
                    lap.number,
                    formatTime(lap.time),
                    formatTime(driver.targetTime),
                    lap.lapType === 'changeover' ? '*****' : `${lap.delta > 0 ? '+' : ''}${formatTime(Math.abs(lap.delta))}`,
                    lap.lapType === 'bonus' ? 'Bonus (+2)' :
                    lap.lapType === 'broken' ? 'Broken (0)' :
                    lap.lapType === 'changeover' ? 'Changeover (+1)' : 'Base (+1)'
                ]);

                if (lapData.length > 0) {
                    doc.autoTable({
                        startY: statsY + 59,
                        head: [['Lap #', 'Time', 'Target', 'Delta', 'Type']],
                        body: lapData,
                        theme: 'striped',
                        headStyles: { fillColor: [30, 64, 175] },
                        styles: { fontSize: 9 },
                        didParseCell: function(data) {
                            // Color the Type column (column 4) based on lap type
                            if (data.column.index === 4 && data.section === 'body') {
                                const lapType = driver.laps[data.row.index].lapType;
                                if (lapType === 'broken') {
                                    data.cell.styles.textColor = [239, 68, 68]; // Red
                                } else if (lapType === 'bonus') {
                                    data.cell.styles.textColor = [34, 197, 94]; // Green
                                } else if (lapType === 'base') {
                                    data.cell.styles.textColor = [59, 130, 246]; // Blue
                                } else if (lapType === 'changeover') {
                                    data.cell.styles.textColor = [168, 85, 247]; // Purple
                                }
                            }
                        }
                    });

                    // Add charts page
                    doc.addPage();

                    // Add Lap Times Chart
                    doc.setFontSize(16);
                    doc.setTextColor(30, 64, 175);
                    doc.text('Lap Times Over Time', 20, 20);

                    const lapTimesImg = await generateChartImage(driver, 'lapTimes');
                    doc.addImage(lapTimesImg, 'JPEG', 15, 30, 180, 72);

                    // Add Delta Chart
                    doc.setFontSize(16);
                    doc.setTextColor(30, 64, 175);
                    doc.text('Delta from Target', 20, 115);

                    const deltaImg = await generateChartImage(driver, 'delta');
                    doc.addImage(deltaImg, 'JPEG', 15, 125, 180, 72);
                } else {
                    doc.setFontSize(10);
                    doc.setTextColor(100, 100, 100);
                    doc.text('No laps recorded', 105, 110, { align: 'center' });
                }

                // Footer
                const pageCount = doc.internal.getNumberOfPages();
                for (let i = 1; i <= pageCount; i++) {
                    doc.setPage(i);
                    doc.setFontSize(8);
                    doc.setTextColor(150, 150, 150);
                    doc.text(`${driver.name} - ${currentTeam.name}`, 105, 285, { align: 'center' });
                    doc.text(`${currentTeam.name} Scoring: Bonus (+0.99s) = 2 laps | Base (>+0.99s) = 1 lap | Broken (<0s) = 0 laps`, 105, 290, { align: 'center' });
                }

                const raceName = currentTeam.raceName ? `${currentTeam.raceName.replace(/\s+/g, '-')}-` : '';
                const sessionNumber = currentTeam.sessionNumber ? `Session-${currentTeam.sessionNumber}-` : '';
                doc.save(`${raceName}${driver.name.replace(/\s+/g, '-')}-${sessionNumber}${new Date().toISOString().split('T')[0]}.pdf`);
            };

            const generateDriverPDFOld = (teamIndex, driverIndex) => {
                const currentTeam = teams[teamIndex];
                const driver = currentTeam.drivers[driverIndex];
                const avgDelta = getAverageDelta(driver, true);
                const totalTime = driver.laps.reduce((acc, lap) => acc + lap.time, 0);
                const bestLap = driver.laps.length > 0 ? Math.min(...driver.laps.map(l => Math.abs(l.delta))) : 0;
                const worstLap = driver.laps.length > 0 ? Math.max(...driver.laps.map(l => Math.abs(l.delta))) : 0;

                let htmlContent = `
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <meta charset="utf-8">
                        <title>${driver.name} - Race Report</title>
                        <style>
                            body { font-family: Arial, sans-serif; margin: 40px; color: #333; }
                            h1 { color: #1e40af; border-bottom: 3px solid #1e40af; padding-bottom: 10px; }
                            h2 { color: #1e40af; margin-top: 20px; border-bottom: 2px solid #ddd; padding-bottom: 5px; }
                            table { width: 100%; border-collapse: collapse; margin: 20px 0; }
                            th, td { border: 1px solid #ddd; padding: 12px; text-align: left; }
                            th { background-color: #1e40af; color: white; font-weight: bold; }
                            tr:nth-child(even) { background-color: #f9f9f9; }
                            .stats { background-color: #f0f0f0; padding: 15px; border-radius: 5px; margin: 15px 0; }
                            .stats-row { display: flex; justify-content: space-between; margin: 5px 0; }
                            .bonus { color: #16a34a; font-weight: bold; }
                            .broken { color: #dc2626; font-weight: bold; }
                            .base { color: #2563eb; font-weight: bold; }
                            .changeover { color: #9333ea; font-weight: bold; }
                            .footer { margin-top: 30px; text-align: center; color: #666; font-size: 12px; }
                            .driver-header { background-color: #e0f2fe; padding: 20px; border-radius: 5px; margin: 20px 0; }
                            .highlight { font-size: 24px; font-weight: bold; color: #1e40af; }
                        </style>
                    </head>
                    <body>
                        <h1> ${driver.name} - Race Report</h1>
                        <p><strong>Team:</strong> ${currentTeam.name}</p>
                        <p><strong>Generated:</strong> ${new Date().toLocaleString()}</p>

                        <div class="driver-header">
                            <div class="stats-row">
                                <span><strong>Target Lap Time:</strong></span>
                                <span class="highlight">${driver.targetTime.toFixed(2)}s</span>
                            </div>
                            <div class="stats-row">
                                <span><strong>Total Laps Run:</strong></span>
                                <span class="highlight">${driver.laps.length}</span>
                            </div>
                            <div class="stats-row">
                                <span><strong>Achieved Laps:</strong></span>
                                <span class="highlight bonus">${getDriverAchievedLaps(driver)}</span>
                            </div>
                            <div class="stats-row">
                                <span><strong>Goal Laps:</strong></span>
                                <span class="highlight">${calculateDriverGoalLaps(driver, currentTeam).toFixed(2)}</span>
                            </div>
                        </div>

                        <div class="stats">
                            <h2>Performance Statistics</h2>
                            <div class="stats-row">
                                <span><strong>Base Laps:</strong></span>
                                <span>${getDriverBaseLaps(driver)}</span>
                            </div>
                            <div class="stats-row">
                                <span><strong>Bonus Laps:</strong></span>
                                <span class="bonus">${getDriverBonusLaps(driver)}</span>
                            </div>
                            <div class="stats-row">
                                <span><strong>Changeover Laps:</strong></span>
                                <span class="changeover">${getDriverChangeoverLaps(driver)}</span>
                            </div>
                            <div class="stats-row">
                                <span><strong>Broken Laps:</strong></span>
                                <span class="broken">${getDriverBrokenLaps(driver)}</span>
                            </div>
                            <div class="stats-row">
                                <span><strong>Penalty Laps:</strong></span>
                                <span class="broken">${driver.penaltyLaps}</span>
                            </div>
                            <div class="stats-row">
                                <span><strong>Average Delta:</strong></span>
                                <span class="${avgDelta > 0.99 ? 'base' : avgDelta < 0 ? 'broken' : 'bonus'}">
                                    ${avgDelta > 0 ? '+' : ''}${avgDelta.toFixed(2)}s
                                </span>
                            </div>
                            <div class="stats-row">
                                <span><strong>Total Time:</strong></span>
                                <span>${totalTime.toFixed(2)}s</span>
                            </div>
                            <div class="stats-row">
                                <span><strong>Best Consistency:</strong></span>
                                <span>${bestLap.toFixed(2)}s variance</span>
                            </div>
                            <div class="stats-row">
                                <span><strong>Worst Consistency:</strong></span>
                                <span>${worstLap.toFixed(2)}s variance</span>
                            </div>
                        </div>

                        <h2>Detailed Lap Times</h2>
                        <table>
                            <thead>
                                <tr>
                                    <th>Lap #</th>
                                    <th>Time</th>
                                    <th>Target</th>
                                    <th>Delta</th>
                                    <th>Type</th>
                                </tr>
                            </thead>
                            <tbody>
                `;

                if (driver.laps.length === 0) {
                    htmlContent += `<tr><td colspan="5" style="text-align: center; color: #999;">No laps recorded</td></tr>`;
                } else {
                    driver.laps.forEach(lap => {
                        const statusClass = lap.lapType === 'bonus' ? 'bonus' :
                                          lap.lapType === 'broken' ? 'broken' :
                                          lap.lapType === 'changeover' ? 'changeover' : 'base';
                        const statusText = lap.lapType === 'bonus' ? 'Bonus (+2)' :
                                         lap.lapType === 'broken' ? 'Broken (0)' :
                                         lap.lapType === 'changeover' ? 'Changeover (+1)' : 'Base (+1)';

                        htmlContent += `
                            <tr>
                                <td>${lap.number}</td>
                                <td>${formatTime(lap.time)}</td>
                                <td>${formatTime(driver.targetTime)}</td>
                                <td class="${statusClass}">${lap.lapType === 'changeover' ? '*****' : (lap.delta > 0 ? '+' : '') + formatTime(Math.abs(lap.delta))}</td>
                                <td class="${statusClass}">${statusText}</td>
                            </tr>
                        `;
                    });
                }

                htmlContent += `
                            </tbody>
                        </table>

                        <div class="footer">
                            <p>${driver.name} - ${currentTeam.name}</p>
                            <p>${currentTeam.name} Scoring System: Bonus (+0.99s) = 2 laps | Base (>+0.99s) = 1 lap | Broken (<0s) = 0 laps</p>
                        </div>
                    </body>
                    </html>
                `;

                const blob = new Blob([htmlContent], { type: 'text/html' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `${driver.name.replace(/\s+/g, '-')}-report-${new Date().toISOString().split('T')[0]}.html`;
                link.click();
                URL.revokeObjectURL(url);

                alert('Report downloaded! Open the HTML file in your browser and use Print > Save as PDF to create a PDF.');
            };


            const importData = (event) => {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = JSON.parse(e.target.result);
                        if (data.teams) {
                            setTeams(data.teams);
                            if (data.activeTeam !== undefined) {
                                setActiveTeam(data.activeTeam);
                            }
                            if (data.activeDriver !== undefined) {
                                setActiveDriver(data.activeDriver);
                            }
                        }
                    } catch (error) {
                        alert('Error importing data. Please check the file format.');
                    }
                };
                reader.readAsText(file);
                event.target.value = '';
            };

            const exportData = () => {
                const data = {
                    teams,
                    activeTeam,
                    activeDriver,
                    exportDate: new Date().toISOString()
                };

                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `race-data-${new Date().toISOString().split('T')[0]}.json`;
                link.click();
                URL.revokeObjectURL(url);
                setShowDataDropdown(false);
            };

            const clearAllData = () => {
                if (confirm('Are you sure you want to clear all data? This cannot be undone.')) {
                    const resetTeams = [
                        {
                            id: 1,
                            name: 'Blind Freddy',
                            sessionNumber: '',
                            drivers: [
                                { id: 1, name: 'Harry', targetTime: 105, laps: [], penaltyLaps: 0 },
                                { id: 2, name: 'Dave', targetTime: 105, laps: [], penaltyLaps: 0 },
                                { id: 3, name: 'Tom', targetTime: 105, laps: [], penaltyLaps: 0 },
                                { id: 4, name: 'Neil', targetTime: 105, laps: [], penaltyLaps: 0 }
                            ]
                        }
                    ];
                    setTeams(resetTeams);
                    setActiveTeam(0);
                    setActiveDriver(0);

                    // Reset the stopwatch timer
                    resetStopwatch();
                }
            };

            const team = teams[0];
            const driver = team.drivers[activeDriver];
            const status = getCurrentStatus(driver);
            const avgDelta = getAverageDelta(driver);

            const bgClass = isDarkMode ? 'bg-gray-900' : 'bg-gradient-to-br from-gray-50 to-gray-100';
            const textClass = isDarkMode ? 'text-white' : 'text-gray-800';
            const cardBgClass = isDarkMode ? 'bg-gray-800' : 'bg-white';
            const cardBgSecondaryClass = isDarkMode ? 'bg-gray-700' : 'bg-gray-100';
            const inputBgClass = isDarkMode ? 'bg-gray-700' : 'bg-white';
            const borderClass = isDarkMode ? 'border-gray-600' : 'border-gray-300';
            const hoverClass = isDarkMode ? 'hover:bg-gray-750' : 'hover:bg-gray-100';
            const tabInactiveClass = isDarkMode ? 'bg-gray-800 text-gray-400 hover:bg-gray-700' : 'bg-white text-gray-700 hover:bg-gray-50 border border-gray-300';
            const labelClass = isDarkMode ? 'text-gray-400' : 'text-gray-700';
            const statLabelClass = isDarkMode ? 'text-gray-400' : 'text-gray-600';
            const stopwatchClass = isDarkMode ? 'text-yellow-400' : 'text-yellow-600';

            return (
                <div className={`min-h-screen ${bgClass} ${textClass} p-4 md:p-6`}>
                    <div className="max-w-[1600px] mx-auto">
                        <div className="flex items-center justify-between mb-6 flex-wrap gap-3">
                            <div className="flex items-center gap-3">
                                <Flag className="w-8 h-8 text-yellow-400" />
                                <h1 className="text-3xl font-bold">{teams[activeTeam].name} Race Timer</h1>
                            </div>
                            <div className="flex gap-2 flex-wrap">
                                <button
                                    onClick={() => setShowTeamScoring(!showTeamScoring)}
                                    className="px-4 py-2 bg-purple-600 hover:bg-purple-700 rounded-lg font-semibold transition-colors flex items-center gap-2 text-white"
                                    title="Team Scoring"
                                >
                                    <Users className="w-5 h-5" />
                                    <span>Team Score</span>
                                </button>
                                <button
                                    onClick={() => setShowCharts(!showCharts)}
                                    className="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 rounded-lg font-semibold transition-colors flex items-center gap-2 text-white"
                                    title="View Charts"
                                >
                                    <BarChart className="w-5 h-5" />
                                    <span>Charts</span>
                                </button>
                                <button
                                    onClick={generatePDF}
                                    className="px-4 py-2 bg-gray-600 hover:bg-red-600 rounded-lg font-semibold transition-colors flex items-center gap-2 text-white"
                                    title="Export team report as PDF"
                                >
                                    <FileText className="w-5 h-5" />
                                    <span>PDF</span>
                                </button>
                                <div className="relative">
                                    <button
                                        onClick={() => setShowDataDropdown(!showDataDropdown)}
                                        className="px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg font-semibold transition-colors flex items-center gap-2 text-white"
                                        title="Import/Export data"
                                    >
                                        <Database className="w-5 h-5" />
                                        <span>Data</span>
                                        <ChevronDown className="w-4 h-4" />
                                    </button>
                                    {showDataDropdown && (
                                        <div className={`absolute right-0 mt-2 w-44 rounded-lg shadow-lg ${cardBgClass} border ${isDarkMode ? 'border-gray-700' : 'border-gray-300'} z-50`}>
                                            <label className={`w-full text-left px-4 py-2 ${hoverClass} flex items-center gap-2 text-green-400 cursor-pointer rounded-t-lg`}>
                                                <Upload className="w-4 h-4" />
                                                Import
                                                <input
                                                    type="file"
                                                    accept=".json"
                                                    onChange={importData}
                                                    className="hidden"
                                                />
                                            </label>
                                            <button
                                                onClick={exportData}
                                                className={`w-full text-left px-4 py-2 ${hoverClass} flex items-center gap-2 text-blue-400 rounded-b-lg`}
                                            >
                                                <Download className="w-4 h-4" />
                                                Export
                                            </button>
                                        </div>
                                    )}
                                </div>
                                <div className="relative">
                                    <button
                                        onClick={() => setShowClearDropdown(!showClearDropdown)}
                                        className="px-4 py-2 bg-orange-600 hover:bg-orange-700 rounded-lg font-semibold transition-colors flex items-center gap-2 text-white"
                                        title="Clear data"
                                    >
                                        <RefreshCw className="w-5 h-5" />
                                        <span>Clear</span>
                                        <ChevronDown className="w-4 h-4" />
                                    </button>
                                    {showClearDropdown && (
                                        <div className={`absolute right-0 mt-2 w-56 rounded-lg shadow-lg ${cardBgClass} border ${isDarkMode ? 'border-gray-700' : 'border-gray-300'} z-50`}>
                                            <button
                                                onClick={() => clearDriverLaps(activeTeam, activeDriver)}
                                                className={`w-full text-left px-4 py-3 ${hoverClass} transition-colors flex items-center gap-2 rounded-t-lg`}
                                            >
                                                <Trash2 className="w-4 h-4" />
                                                <span>Clear This Driver</span>
                                            </button>
                                            <button
                                                onClick={() => clearAllDrivers(activeTeam)}
                                                className={`w-full text-left px-4 py-3 ${hoverClass} transition-colors flex items-center gap-2 rounded-b-lg border-t ${isDarkMode ? 'border-gray-700' : 'border-gray-300'}`}
                                            >
                                                <Trash2 className="w-4 h-4" />
                                                <span>Clear All Drivers</span>
                                            </button>
                                        </div>
                                    )}
                                </div>
                                <div className="flex gap-2">
                                    <button
                                        onClick={() => setShowSettings(true)}
                                        className={`px-4 py-2 ${isDarkMode ? 'bg-gray-600 hover:bg-gray-700' : 'bg-gray-300 hover:bg-gray-400'} rounded-lg font-semibold transition-colors`}
                                        title="Settings"
                                    >
                                        <Settings className="w-5 h-5" />
                                    </button>
                                    <button
                                        onClick={() => setIsDarkMode(!isDarkMode)}
                                        className={`px-4 py-2 ${isDarkMode ? 'bg-gray-600 hover:bg-gray-700' : 'bg-gray-300 hover:bg-gray-400'} rounded-lg font-semibold transition-colors`}
                                        title="Toggle theme"
                                    >
                                        {isDarkMode ? '' : ''}
                                    </button>
                                </div>
                            </div>
                        </div>

                        {/* Team Tabs - Hidden for single team */}
                        {teams.length > 1 && (
                            <div className="flex gap-2 mb-4 overflow-x-auto pb-2 items-center">
                                {teams.map((t, idx) => (
                                    <button
                                        key={t.id}
                                        onClick={() => setActiveTeam(idx)}
                                        className={`px-6 py-3 rounded-t-lg font-semibold transition-colors whitespace-nowrap ${
                                            activeTeam === idx ? 'bg-purple-600 text-white' : tabInactiveClass
                                        }`}
                                    >
                                        {t.name}
                                    </button>
                                ))}
                            </div>
                        )}

                        {/* Driver Tabs */}
                        <div className="flex gap-2 mb-6 overflow-x-auto pb-2 items-center justify-between flex-wrap">
                            <div className="flex gap-2">
                                {team.drivers.map((d, idx) => (
                                    <button
                                        key={d.id}
                                        onClick={() => setActiveDriver(idx)}
                                        className={`px-6 py-3 rounded-t-lg font-semibold transition-colors whitespace-nowrap ${
                                            activeDriver === idx ? 'bg-blue-600 text-white' : tabInactiveClass
                                        }`}
                                    >
                                        {d.name} ({d.laps.length})
                                    </button>
                                ))}
                            </div>
                            <div className="flex items-center gap-4">
                                <div className="flex items-center gap-2">
                                    <label className={`text-sm font-semibold ${labelClass}`}>Team:</label>
                                    <input
                                        type="text"
                                        value={team.name}
                                        onChange={(e) => updateTeamName(0, e.target.value)}
                                        placeholder="Team name"
                                        className={`w-40 px-3 py-2 ${inputBgClass} rounded-lg border ${borderClass} focus:border-blue-500 focus:outline-none text-sm`}
                                    />
                                </div>
                                <div className="flex items-center gap-2">
                                    <label className={`text-sm font-semibold ${labelClass}`}>Race:</label>
                                    <input
                                        type="text"
                                        value={team.raceName || ''}
                                        onChange={(e) => {
                                            const updatedTeams = [...teams];
                                            updatedTeams[0].raceName = e.target.value;
                                            setTeams(updatedTeams);
                                        }}
                                        placeholder="e.g., Sandown 500, Bathurst 6hr..."
                                        className={`w-40 px-3 py-2 ${inputBgClass} rounded-lg border ${borderClass} focus:border-blue-500 focus:outline-none text-sm`}
                                    />
                                </div>
                                <div className="flex items-center gap-2">
                                    <label className={`text-sm font-semibold ${labelClass}`}>Session #:</label>
                                    <input
                                        type="text"
                                        value={team.sessionNumber || ''}
                                        onChange={(e) => {
                                            const updatedTeams = [...teams];
                                            updatedTeams[0].sessionNumber = e.target.value;
                                            setTeams(updatedTeams);
                                        }}
                                        placeholder="e.g., 1, 2, 3..."
                                        className={`w-24 px-3 py-2 ${inputBgClass} rounded-lg border ${borderClass} focus:border-blue-500 focus:outline-none text-sm`}
                                    />
                                </div>
                                <div className="flex items-center gap-2">
                                    <label className={`text-sm font-semibold ${labelClass}`}>Session Duration (mins):</label>
                                    <input
                                        type="number"
                                        value={team.sessionDuration || 120}
                                        onChange={(e) => {
                                            const updatedTeams = [...teams];
                                            updatedTeams[0].sessionDuration = parseFloat(e.target.value) || 600;
                                            setTeams(updatedTeams);
                                        }}
                                        placeholder="120"
                                        className={`w-24 px-3 py-2 ${inputBgClass} rounded-lg border ${borderClass} focus:border-blue-500 focus:outline-none text-sm`}
                                    />
                                </div>
                            </div>
                        </div>

                        <div className="grid grid-cols-3 gap-6">
                            <div className="flex flex-col gap-6">
                                <div className={`${cardBgClass} rounded-lg p-4 shadow-lg`}>
                                    <h2 className="text-base font-bold mb-2">Driver Settings</h2>
                                    <div className="space-y-2">
                                        <div>
                                            <label className={`block text-xs ${labelClass} mb-0.5 font-semibold`}>Name</label>
                                            <input
                                                type="text"
                                                value={driver.name}
                                                onChange={(e) => updateDriverName(0, activeDriver, e.target.value)}
                                                className={`w-full px-2 py-1.5 ${inputBgClass} rounded border ${borderClass} focus:border-blue-500 focus:outline-none text-sm`}
                                            />
                                        </div>
                                        <div className="grid grid-cols-2 gap-2">
                                            <div>
                                                <label className={`block text-xs ${labelClass} mb-0.5 font-semibold`}>Target (s)</label>
                                                <input
                                                    type="number"
                                                    step="0.01"
                                                    value={driver.targetTime}
                                                    onChange={(e) => updateTargetTime(0, activeDriver, e.target.value)}
                                                    className={`w-full px-2 py-1.5 ${inputBgClass} rounded border ${borderClass} focus:border-blue-500 focus:outline-none text-sm`}
                                                />
                                                <div className={`text-xs ${statLabelClass} mt-0.5`}>
                                                    {driver.targetTime ? `${Math.floor(driver.targetTime / 60)}:${(driver.targetTime % 60).toFixed(0).padStart(2, '0')}` : ''}
                                                </div>
                                            </div>
                                            <div>
                                                <label className={`block text-xs ${labelClass} mb-0.5 font-semibold`}>Penalty</label>
                                                <input
                                                    type="number"
                                                    value={driver.penaltyLaps}
                                                    onChange={(e) => updatePenaltyLaps(0, activeDriver, e.target.value)}
                                                    className={`w-full px-2 py-1.5 ${inputBgClass} rounded border ${borderClass} focus:border-blue-500 focus:outline-none text-sm`}
                                                />
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div className={`${cardBgClass} rounded-lg p-5 shadow-lg flex flex-col flex-1`}>
                                    <div className="flex justify-between items-center mb-3">
                                        <h2 className="text-lg font-bold">Driver Statistics</h2>
                                        <button
                                            onClick={() => generateDriverPDF(0, activeDriver)}
                                            className="px-3 py-1.5 bg-gray-600 hover:bg-red-600 text-white rounded font-semibold transition-colors flex items-center gap-1 text-sm"
                                            title="Export driver report as PDF"
                                        >
                                            <FileText className="w-4 h-4" />
                                            <span>PDF</span>
                                        </button>
                                    </div>
                                    <div className="space-y-2 text-sm flex-1 flex flex-col justify-center">
                                        <div className="flex justify-between">
                                            <span className={statLabelClass}>Achieved Laps:</span>
                                            <span className="font-bold text-yellow-600">{getDriverAchievedLaps(driver)}</span>
                                        </div>
                                        <div className="flex justify-between">
                                            <span className={statLabelClass}>Net Score:</span>
                                            <span className="font-bold text-blue-400">{getDriverBonusLaps(driver) - getDriverBrokenLaps(driver)}</span>
                                        </div>
                                        <div className="flex justify-between">
                                            <span className={statLabelClass}>Base Laps:</span>
                                            <span className="font-bold">{getDriverBaseLaps(driver)}</span>
                                        </div>
                                        <div className="flex justify-between">
                                            <span className={statLabelClass}>Bonus Laps:</span>
                                            <span className="font-bold text-green-400">{getDriverBonusLaps(driver)}</span>
                                        </div>
                                        <div className="flex justify-between">
                                            <span className={statLabelClass}>Changeover:</span>
                                            <span className="font-bold text-purple-400">{getDriverChangeoverLaps(driver)}</span>
                                        </div>
                                        <div className="flex justify-between">
                                            <span className={statLabelClass}>Broken Laps:</span>
                                            <span className="font-bold text-red-400">{getDriverBrokenLaps(driver)}</span>
                                        </div>
                                        <div className="flex justify-between">
                                            <span className={statLabelClass}>Penalty Laps:</span>
                                            <span className="font-bold text-red-400">{driver.penaltyLaps}</span>
                                        </div>
                                        <div className="flex justify-between pt-2 border-t border-gray-600">
                                            <span className={statLabelClass}>3-Lap Avg Delta:</span>
                                            <div className="flex items-center gap-2">
                                                {(() => {
                                                    const signalColor = getDriverSignalColor(driver);
                                                    if (!signalColor) return null;
                                                    return <div className={`w-3 h-3 rounded-full ${signalColor}`} title="Signal indicator"></div>;
                                                })()}
                                                <span className={`font-bold ${(() => {
                                                    const avg = getDriver3LapAverage(driver);
                                                    if (avg === null) return '';

                                                    if (avg >= 0.3 && avg < 1.0) return 'text-green-400';
                                                    if (avg < 0.3) return 'text-red-400';
                                                    return 'text-blue-400';
                                                })()}`}>
                                                    {(() => {
                                                        const avg = getDriver3LapAverage(driver);
                                                        if (avg === null) return '-';
                                                        return (
                                                            <React.Fragment>
                                                                {`${avg > 0 ? '+' : ''}${avg.toFixed(2)}s`}
                                                                {avg < 0.3 && <span className="ml-1">(Slow Down)</span>}
                                                                {avg >= 0.3 && avg < 1.0 && <span className="ml-1">(Good)</span>}
                                                                {avg >= 1.0 && <span className="ml-1">(Too Slow)</span>}
                                                            </React.Fragment>
                                                        );
                                                    })()}
                                                </span>
                                            </div>
                                        </div>
                                        <div className="flex justify-between">
                                            <span className={statLabelClass}>Goal Laps:</span>
                                            <span className="font-bold">{isNaN(calculateDriverGoalLaps(driver, team)) ? '-' : calculateDriverGoalLaps(driver, team).toFixed(2)}</span>
                                        </div>
                                        <div className="flex justify-between pt-2 border-t border-gray-600">
                                            <span className={statLabelClass}>Average Delta:</span>
                                            <span className={`font-bold ${
                                                avgDelta >= 0.3 && avgDelta < 1.0 ? 'text-green-400' :
                                                avgDelta < 0.3 ? 'text-red-400' :
                                                'text-blue-400'
                                            }`}>
                                                {isNaN(avgDelta) ? '-' : (
                                                    <React.Fragment>
                                                        {`${avgDelta > 0 ? '+' : ''}${avgDelta.toFixed(2)}s`}
                                                        {avgDelta < 0.3 && <span className="ml-1">(Slow Down)</span>}
                                                        {avgDelta >= 0.3 && avgDelta < 1.0 && <span className="ml-1">(Good)</span>}
                                                        {avgDelta >= 1.0 && <span className="ml-1">(Too Slow)</span>}
                                                    </React.Fragment>
                                                )}
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div className="flex flex-col gap-6">
                                <div className={`${cardBgClass} rounded-lg p-5 shadow-lg`}>
                                    <h2 className="text-lg font-bold mb-3">Live Stopwatch</h2>
                                    <div className={`${cardBgSecondaryClass} rounded-lg p-6 text-center ${showWarning ? 'ring-4 ring-orange-500 animate-pulse' : ''}`}>
                                        <div className="flex items-center justify-center gap-3 mb-2">
                                            <div className="text-lg font-bold text-blue-500">
                                                {isRunning && timerDriverIndex !== null ? team.drivers[timerDriverIndex].name : driver.name}
                                            </div>
                                            <div className={`text-lg font-bold ${statLabelClass}`}>|</div>
                                            <div className={`text-lg font-bold ${textClass}`}>
                                                Lap {isRunning && timerDriverIndex !== null ? team.drivers[timerDriverIndex].laps.length + 1 : driver.laps.length + 1}
                                            </div>
                                        </div>
                                        <div className={`text-xs ${statLabelClass} mb-3`}>
                                            {!isRunning ? 'Press Enter to start timing' : showWarning ? ' 10 SECOND WARNING ' : 'Press Enter to record lap & start next'}
                                        </div>
                                        <div className={`text-7xl font-mono font-bold ${showWarning ? 'text-orange-500' : stopwatchClass} mb-4`}>
                                            {elapsedTime.toFixed(2)}s
                                        </div>
                                        <div className="flex gap-2 justify-center mb-4">
                                            {!isRunning ? (
                                                <button
                                                    onClick={startStopwatch}
                                                    className="px-6 py-2 bg-green-600 hover:bg-green-700 rounded-lg font-semibold transition-colors text-white"
                                                >
                                                    Start
                                                </button>
                                            ) : (
                                                <button
                                                    onClick={stopStopwatch}
                                                    className="px-6 py-2 bg-red-600 hover:bg-red-700 rounded-lg font-semibold transition-colors text-white"
                                                >
                                                    Stop
                                                </button>
                                            )}
                                            <button
                                                onClick={resetStopwatch}
                                                className="px-6 py-2 bg-gray-600 hover:bg-gray-700 rounded-lg font-semibold transition-colors text-white"
                                            >
                                                Reset
                                            </button>
                                        </div>
                                        {isRunning && (
                                            <div className="mb-4">
                                                <button
                                                    onClick={() => {
                                                        const lapTime = elapsedTime;
                                                        const updatedTeams = [...teams];
                                                        const team = updatedTeams[0];
                                                        const currentDriver = team.drivers[activeDriver];

                                                        const delta = lapTime - currentDriver.targetTime;
                                                        const lapNumber = currentDriver.laps.length + 1;

                                                        const newLap = {
                                                            number: lapNumber,
                                                            time: lapTime,
                                                            delta: delta,
                                                            lapType: 'changeover',
                                                            lapValue: 1
                                                        };

                                                        currentDriver.laps.push(newLap);
                                                        setTeams(updatedTeams);

                                                        setChangeoverLapInfo({
                                                            teamIndex: 0,
                                                            driverIndex: activeDriver,
                                                            lapIndex: currentDriver.laps.length - 1
                                                        });
                                                        setShowDriverSwitch(true);
                                                    }}
                                                    className="px-4 py-2 bg-purple-600 hover:bg-purple-700 rounded-lg font-semibold transition-colors text-white flex items-center gap-2 mx-auto"
                                                >
                                                    <Repeat className="w-4 h-4" />
                                                    Changeover
                                                </button>
                                            </div>
                                        )}
                                        <div className={`text-xs ${statLabelClass}`}>
                                            Or type time manually to the right
                                        </div>
                                    </div>
                                </div>

                                <div className={`${status.color} rounded-lg p-8 text-center shadow-lg flex-1 flex flex-col items-center justify-center text-white`}>
                                    <div className="text-5xl font-bold mb-3">{status.signal}</div>
                                    <div className="text-xl">{status.message}</div>
                                </div>
                            </div>

                            <div className="flex flex-col gap-6">
                                <div className={`${cardBgClass} rounded-lg p-5 shadow-lg`}>
                                    <div className="flex gap-2">
                                        <input
                                            type="text"
                                            value={lapInput}
                                            onChange={(e) => setLapInput(e.target.value)}
                                            placeholder="Manual lap time (optional)"
                                            className={`flex-1 px-3 py-2 ${inputBgClass} rounded-lg border ${borderClass} focus:border-blue-500 focus:outline-none text-sm`}
                                        />
                                        <button
                                            onClick={addLap}
                                            className="px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg font-semibold transition-colors text-white"
                                        >
                                            <Plus className="w-5 h-5" />
                                        </button>
                                    </div>
                                </div>

                                <div className={`${cardBgClass} rounded-lg p-5 shadow-lg flex-1`}>
                                    <div className="flex justify-between items-center mb-3">
                                        <h2 className="text-lg font-bold">Lap History</h2>
                                        <div className="flex items-center gap-3">
                                            <div className="flex gap-6 text-right">
                                                <div>
                                                    <div className={`text-xs ${statLabelClass}`}>Avg Lap Time</div>
                                                    <div className="text-2xl font-bold">
                                                        {driver.laps.length > 0
                                                            ? formatTime(driver.laps.reduce((sum, lap) => sum + lap.time, 0) / driver.laps.length)
                                                            : '-'}
                                                    </div>
                                                </div>
                                                <div>
                                                    <div className={`text-xs ${statLabelClass}`}>Base Laps</div>
                                                    <div className="text-2xl font-bold">{driver.laps.length}</div>
                                                </div>
                                                <div>
                                                    <div className={`text-xs ${statLabelClass}`}>Achieved Laps</div>
                                                    <div className="text-2xl font-bold text-yellow-600">{getDriverAchievedLaps(driver)}</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div className="overflow-y-auto" style={{maxHeight: '400px'}}>
                                        <table className="w-full text-sm table-fixed">
                                            <thead className={`sticky top-0 ${cardBgClass}`}>
                                                <tr className={`border-b ${isDarkMode ? 'border-gray-700' : 'border-gray-300'}`}>
                                                    <th className="text-left py-2 px-2 w-8">Lap</th>
                                                    <th className="text-left py-2 px-2 w-20">Time</th>
                                                    <th className="text-left py-2 px-2 w-20">Delta</th>
                                                    <th className="text-left py-2 px-2 w-16">Type</th>
                                                    <th className="text-center py-2 px-2 w-12">Laps</th>
                                                    <th className="text-center py-2 px-2 w-20" title="3-lap rolling average delta">3-Lap </th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {driver.laps.length === 0 ? (
                                                    <tr>
                                                        <td colSpan="6" className={`text-center py-8 ${statLabelClass} text-sm`}>No laps recorded yet</td>
                                                    </tr>
                                                ) : (
                                                    [...driver.laps].reverse().map((lap, idx) => {
                                                        const originalIdx = driver.laps.length - 1 - idx;

                                                        // Hide changeover lap if it's pending transfer
                                                        if (showDriverSwitch && changeoverLapInfo &&
                                                            changeoverLapInfo.driverIndex === activeDriver &&
                                                            changeoverLapInfo.lapIndex === originalIdx) {
                                                            return null;
                                                        }

                                                        return (
                                                            <tr
                                                                key={originalIdx}
                                                                className={`border-b ${isDarkMode ? 'border-gray-700' : 'border-gray-300'} ${hoverClass} cursor-context-menu`}
                                                                onContextMenu={(e) => {
                                                                    e.preventDefault();

                                                                    // Calculate position with edge detection
                                                                    const menuWidth = 200;
                                                                    const menuHeight = 100; // approximate
                                                                    let x = e.pageX;
                                                                    let y = e.pageY;

                                                                    // Check right edge
                                                                    if (x + menuWidth > window.innerWidth + window.scrollX) {
                                                                        x = e.pageX - menuWidth;
                                                                    }

                                                                    // Check bottom edge
                                                                    if (y + menuHeight > window.innerHeight + window.scrollY) {
                                                                        y = e.pageY - menuHeight;
                                                                    }

                                                                    setContextMenu({
                                                                        visible: true,
                                                                        x: x,
                                                                        y: y,
                                                                        teamIndex: 0,
                                                                        driverIndex: activeDriver,
                                                                        lapIndex: originalIdx
                                                                    });
                                                                }}
                                                            >
                                                                <td className="py-2 px-2 font-bold">#{lap.number}</td>
                                                                <td
                                                                    className="py-2 px-2 cursor-pointer hover:bg-opacity-20 hover:bg-blue-500"
                                                                    onDoubleClick={(e) => {
                                                                        e.stopPropagation();
                                                                        setEditingLap({ teamIndex: 0, driverIndex: activeDriver, lapIndex: originalIdx, value: formatTime(lap.time) });
                                                                    }}
                                                                    title="Double-click to edit"
                                                                >
                                                                    {editingLap.teamIndex === 0 && editingLap.driverIndex === activeDriver && editingLap.lapIndex === originalIdx ? (
                                                                        <input
                                                                            type="text"
                                                                            value={editingLap.value}
                                                                            onChange={(e) => setEditingLap({ ...editingLap, value: e.target.value })}
                                                                            onBlur={() => {
                                                                                if (editingLap.value && editingLap.value !== formatTime(lap.time)) {
                                                                                    updateLapTime(0, activeDriver, originalIdx, editingLap.value);
                                                                                } else {
                                                                                    setEditingLap({ teamIndex: null, driverIndex: null, lapIndex: null, value: '' });
                                                                                }
                                                                            }}
                                                                            onKeyDown={(e) => {
                                                                                if (e.key === 'Enter') {
                                                                                    updateLapTime(0, activeDriver, originalIdx, editingLap.value);
                                                                                } else if (e.key === 'Escape') {
                                                                                    setEditingLap({ teamIndex: null, driverIndex: null, lapIndex: null, value: '' });
                                                                                }
                                                                            }}
                                                                            onClick={(e) => e.stopPropagation()}
                                                                            className={`w-24 px-1 py-0 rounded border ${isDarkMode ? 'bg-gray-700 border-gray-600 text-white' : 'bg-white border-gray-300 text-black'}`}
                                                                            autoFocus
                                                                            placeholder="M:SS.mmm"
                                                                        />
                                                                    ) : (
                                                                        <span title={formatTimeWithMilliseconds(lap.time)}>
                                                                            {formatTime(lap.time)}
                                                                        </span>
                                                                    )}
                                                                </td>
                                                                <td className={`py-2 px-2 font-bold ${
                                                                    lap.lapType === 'broken' ? 'text-red-400' :
                                                                    lap.lapType === 'bonus' ? 'text-green-400' :
                                                                    lap.lapType === 'changeover' ? 'text-purple-400' :
                                                                    lap.lapType === 'safety' ? 'text-yellow-400' :
                                                                    'text-blue-400'
                                                                }`}>
                                                                    {lap.lapType === 'changeover' ? '***' : lap.lapType === 'safety' ? 'SC' : (!isNaN(lap.delta) ? `${lap.delta > 0 ? '+' : ''}${lap.delta.toFixed(2)}s` : '-')}
                                                                </td>
                                                                <td className="py-2 px-2">
                                                                    {lap.lapType === 'bonus' ? (
                                                                        <span className="text-green-400 font-bold">Bonus</span>
                                                                    ) : lap.lapType === 'base' ? (
                                                                        <span className="text-blue-400 font-bold">Base</span>
                                                                    ) : lap.lapType === 'changeover' ? (
                                                                        <span className="text-purple-400 font-bold">C/O</span>
                                                                    ) : lap.lapType === 'safety' ? (
                                                                        <span className="text-yellow-400 font-bold">Safety</span>
                                                                    ) : (
                                                                        <span className="text-red-400 font-bold">Broken</span>
                                                                    )}
                                                                </td>
                                                                <td className="py-2 px-2 font-bold text-center">
                                                                    {lap.lapType === 'bonus' ? (
                                                                        <span className="text-green-400">+2</span>
                                                                    ) : lap.lapType === 'base' ? (
                                                                        <span className="text-blue-400">+1</span>
                                                                    ) : lap.lapType === 'changeover' ? (
                                                                        <span className="text-purple-400">+1</span>
                                                                    ) : lap.lapType === 'safety' ? (
                                                                        <span className="text-yellow-400">0</span>
                                                                    ) : (
                                                                        <span className="text-red-400">0</span>
                                                                    )}
                                                                </td>
                                                                <td className="py-2 px-2 text-center font-bold">
                                                                    {(() => {
                                                                        const avg = get3LapAverageAtIndex(driver, originalIdx);
                                                                        if (avg === null) return '-';
                                                                        const color = avg >= 0.3 && avg < 1.0 ? 'text-green-400' : avg < 0.3 ? 'text-red-400' : 'text-blue-400';
                                                                        return <span className={color}>{avg > 0 ? '+' : ''}{avg.toFixed(2)}s</span>;
                                                                    })()}
                                                                </td>
                                                            </tr>
                                                        );
                                                    })
                                                )}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>


                    {/* Driver Switch Modal */}
                    {showDriverSwitch && changeoverLapInfo && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                            <div className={`${cardBgClass} rounded-lg p-6 max-w-md w-full shadow-2xl`}>
                                <div className="mb-4">
                                    <h2 className="text-2xl font-bold mb-2"> Changeover Lap</h2>
                                    <p className={`text-sm ${statLabelClass}`}>Switch to which driver?</p>
                                </div>

                                <div className="space-y-3">
                                    {team.drivers.map((d, idx) => (
                                        <button
                                            key={d.id}
                                            onClick={() => confirmDriverSwitch(idx)}
                                            disabled={idx === changeoverLapInfo.driverIndex}
                                            className={`w-full px-4 py-3 rounded-lg font-semibold transition-colors text-left flex items-center justify-between ${
                                                idx === changeoverLapInfo.driverIndex
                                                    ? isDarkMode
                                                        ? 'bg-gray-700 text-gray-500 cursor-not-allowed'
                                                        : 'bg-gray-200 text-gray-400 cursor-not-allowed'
                                                    : isDarkMode
                                                        ? 'bg-blue-600 hover:bg-blue-700 text-white'
                                                        : 'bg-blue-600 hover:bg-blue-700 text-white'
                                            }`}
                                        >
                                            <span>{d.name}</span>
                                            {idx === changeoverLapInfo.driverIndex && (
                                                <span className="text-xs">(Current)</span>
                                            )}
                                        </button>
                                    ))}
                                </div>

                                <button
                                    onClick={() => {
                                        setShowDriverSwitch(false);
                                        setChangeoverLapInfo(null);
                                    }}
                                    className={`mt-4 w-full px-4 py-2 rounded-lg font-semibold transition-colors ${
                                        isDarkMode
                                            ? 'bg-gray-700 hover:bg-gray-600 text-white'
                                            : 'bg-gray-300 hover:bg-gray-400 text-gray-800'
                                    }`}
                                >
                                    Cancel
                                </button>
                            </div>
                        </div>
                    )}

                    {/* Team Scoring Modal */}
                    {showSettings && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                            <div className={`${cardBgClass} rounded-lg p-6 max-w-4xl w-full shadow-2xl max-h-[90vh] overflow-y-auto`}>
                                <div className="flex justify-between items-center mb-6">
                                    <h2 className="text-2xl font-bold">Settings</h2>
                                    <button
                                        onClick={() => setShowSettings(false)}
                                        className="text-gray-400 hover:text-gray-600 transition-colors"
                                    >
                                        <X className="w-6 h-6" />
                                    </button>
                                </div>

                                <div className="grid grid-cols-2 gap-8">
                                    <div>
                                        <h3 className="text-lg font-semibold mb-4">Audio Warnings</h3>

                                        <div className="space-y-4">
                                            <div className="flex gap-2">
                                                <button
                                                    onClick={() => playBeep(false)}
                                                    className="flex-1 px-4 py-2 bg-blue-500 hover:bg-blue-600 rounded-lg font-semibold transition-colors"
                                                >
                                                    Test Single Beep
                                                </button>
                                                <button
                                                    onClick={() => playBeep(true)}
                                                    className="flex-1 px-4 py-2 bg-blue-500 hover:bg-blue-600 rounded-lg font-semibold transition-colors"
                                                >
                                                    Test Double Beep
                                                </button>
                                            </div>

                                            <div>
                                                <div className="flex items-center justify-between mb-2">
                                                    <label className="block text-sm font-medium">
                                                        Beep before target time (seconds)
                                                    </label>
                                                    <button
                                                        onClick={() => setAudioSettings({
                                                            ...audioSettings,
                                                            beforeTargetEnabled: !audioSettings.beforeTargetEnabled
                                                        })}
                                                        className={`relative inline-flex h-6 w-11 items-center rounded-full transition-colors focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 ${
                                                            audioSettings.beforeTargetEnabled ? 'bg-blue-600' : 'bg-gray-300'
                                                        }`}
                                                    >
                                                        <span
                                                            className={`inline-block h-4 w-4 transform rounded-full bg-white transition-transform ${
                                                                audioSettings.beforeTargetEnabled ? 'translate-x-6' : 'translate-x-1'
                                                            }`}
                                                        />
                                                    </button>
                                                </div>
                                                <input
                                                    type="number"
                                                    min="1"
                                                    max="60"
                                                    value={audioSettings.beforeTargetTime}
                                                    onChange={(e) => setAudioSettings({
                                                        ...audioSettings,
                                                        beforeTargetTime: parseInt(e.target.value) || 10
                                                    })}
                                                    disabled={!audioSettings.beforeTargetEnabled}
                                                    className={`w-full px-3 py-2 ${inputBgClass} border ${borderClass} rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 ${!audioSettings.beforeTargetEnabled ? 'opacity-50 cursor-not-allowed' : ''}`}
                                                />
                                                <p className="text-xs text-gray-500 mt-1">
                                                    Play a beep when this many seconds remain before target time
                                                </p>
                                            </div>

                                            <div>
                                                <div className="flex items-center justify-between mb-2">
                                                    <label className="block text-sm font-medium">
                                                        Beep after lap start (seconds)
                                                    </label>
                                                    <button
                                                        onClick={() => setAudioSettings({
                                                            ...audioSettings,
                                                            afterLapStartEnabled: !audioSettings.afterLapStartEnabled
                                                        })}
                                                        className={`relative inline-flex h-6 w-11 items-center rounded-full transition-colors focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 ${
                                                            audioSettings.afterLapStartEnabled ? 'bg-blue-600' : 'bg-gray-300'
                                                        }`}
                                                    >
                                                        <span
                                                            className={`inline-block h-4 w-4 transform rounded-full bg-white transition-transform ${
                                                                audioSettings.afterLapStartEnabled ? 'translate-x-6' : 'translate-x-1'
                                                            }`}
                                                        />
                                                    </button>
                                                </div>
                                                <input
                                                    type="number"
                                                    min="1"
                                                    max="60"
                                                    value={audioSettings.afterLapStart}
                                                    onChange={(e) => setAudioSettings({
                                                        ...audioSettings,
                                                        afterLapStart: parseInt(e.target.value) || 15
                                                    })}
                                                    disabled={!audioSettings.afterLapStartEnabled}
                                                    className={`w-full px-3 py-2 ${inputBgClass} border ${borderClass} rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 ${!audioSettings.afterLapStartEnabled ? 'opacity-50 cursor-not-allowed' : ''}`}
                                                />
                                                <p className="text-xs text-gray-500 mt-1">
                                                    Play a double beep this many seconds after starting the timer
                                                </p>
                                            </div>
                                        </div>
                                    </div>

                                    <div>
                                        <h3 className="text-lg font-semibold mb-4">Lap Type Values</h3>
                                        <p className="text-sm text-gray-500 mb-4">Configure how many laps each lap type is worth</p>

                                        <div className="space-y-3">
                                            <div className="flex items-center justify-between">
                                                <label className="text-sm font-medium text-green-400">
                                                    Bonus Lap Value
                                                </label>
                                                <input
                                                    type="number"
                                                    min="0"
                                                    max="10"
                                                    step="0.5"
                                                    value={lapTypeValues.bonus}
                                                    onChange={(e) => setLapTypeValues({
                                                        ...lapTypeValues,
                                                        bonus: parseFloat(e.target.value) || 0
                                                    })}
                                                    className={`w-20 px-3 py-2 ${inputBgClass} border ${borderClass} rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-center`}
                                                />
                                            </div>

                                            <div className="flex items-center justify-between">
                                                <label className="text-sm font-medium text-blue-400">
                                                    Base Lap Value
                                                </label>
                                                <input
                                                    type="number"
                                                    min="0"
                                                    max="10"
                                                    step="0.5"
                                                    value={lapTypeValues.base}
                                                    onChange={(e) => setLapTypeValues({
                                                        ...lapTypeValues,
                                                        base: parseFloat(e.target.value) || 0
                                                    })}
                                                    className={`w-20 px-3 py-2 ${inputBgClass} border ${borderClass} rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-center`}
                                                />
                                            </div>

                                            <div className="flex items-center justify-between">
                                                <label className="text-sm font-medium text-purple-400">
                                                    Changeover Lap Value
                                                </label>
                                                <input
                                                    type="number"
                                                    min="0"
                                                    max="10"
                                                    step="0.5"
                                                    value={lapTypeValues.changeover}
                                                    onChange={(e) => setLapTypeValues({
                                                        ...lapTypeValues,
                                                        changeover: parseFloat(e.target.value) || 0
                                                    })}
                                                    className={`w-20 px-3 py-2 ${inputBgClass} border ${borderClass} rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-center`}
                                                />
                                            </div>

                                            <div className="flex items-center justify-between">
                                                <label className="text-sm font-medium text-red-400">
                                                    Broken Lap Value
                                                </label>
                                                <input
                                                    type="number"
                                                    min="0"
                                                    max="10"
                                                    step="0.5"
                                                    value={lapTypeValues.broken}
                                                    onChange={(e) => setLapTypeValues({
                                                        ...lapTypeValues,
                                                        broken: parseFloat(e.target.value) || 0
                                                    })}
                                                    className={`w-20 px-3 py-2 ${inputBgClass} border ${borderClass} rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-center`}
                                                />
                                            </div>

                                            <div className="flex items-center justify-between">
                                                <label className="text-sm font-medium text-yellow-400">
                                                    Safety Car Lap Value
                                                </label>
                                                <input
                                                    type="number"
                                                    min="0"
                                                    max="10"
                                                    step="0.5"
                                                    value={lapTypeValues.safety}
                                                    onChange={(e) => setLapTypeValues({
                                                        ...lapTypeValues,
                                                        safety: parseFloat(e.target.value) || 0
                                                    })}
                                                    className={`w-20 px-3 py-2 ${inputBgClass} border ${borderClass} rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-center`}
                                                />
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    {showTeamScoring && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                            <div className={`${cardBgClass} rounded-lg p-6 max-w-4xl w-full shadow-2xl max-h-[90vh] overflow-y-auto`}>
                                <div className="flex justify-between items-center mb-4">
                                    <h2 className="text-2xl font-bold">Team Scoring</h2>
                                    <button
                                        onClick={() => setShowTeamScoring(false)}
                                        className="text-gray-400 hover:text-gray-600 transition-colors"
                                    >
                                        <X className="w-6 h-6" />
                                    </button>
                                </div>

                                {teams.map((t, teamIdx) => {
                                    const goalLaps = getTeamGoalLaps(t);
                                    const achievedLaps = getTeamAchievedLaps(t);
                                    const percentageFactor = getTeamPercentageFactor(t);

                                    return (
                                        <div key={t.id} className={`${cardBgSecondaryClass} rounded-lg p-5 mb-4`}>
                                            <h3 className="text-xl font-bold mb-4">{t.name}</h3>

                                            <div className="grid grid-cols-3 gap-4 mb-4">
                                                <div className="text-center">
                                                    <div className={`text-sm ${statLabelClass}`}>Goal Laps</div>
                                                    <div className="text-2xl font-bold text-blue-400">{goalLaps.toFixed(2)}</div>
                                                </div>
                                                <div className="text-center">
                                                    <div className={`text-sm ${statLabelClass}`}>Achieved Laps</div>
                                                    <div className="text-2xl font-bold text-yellow-400">{achievedLaps}</div>
                                                </div>
                                                <div className="text-center">
                                                    <div className={`text-sm ${statLabelClass}`}>Percentage Factor</div>
                                                    <div className="text-2xl font-bold text-green-400">{percentageFactor}%</div>
                                                </div>
                                            </div>

                                            <table className="w-full text-sm mt-4">
                                                <thead className={`border-b ${isDarkMode ? 'border-gray-600' : 'border-gray-300'}`}>
                                                    <tr>
                                                        <th className="text-left py-2">Driver</th>
                                                        <th className="text-center py-2">Target</th>
                                                        <th className="text-center py-2">Base</th>
                                                        <th className="text-center py-2">% Team</th>
                                                        <th className="text-center py-2">Bonus</th>
                                                        <th className="text-center py-2">Change</th>
                                                        <th className="text-center py-2">Broken</th>
                                                        <th className="text-center py-2">Penalty</th>
                                                        <th className="text-center py-2">Achieved</th>
                                                        <th className="text-center py-2">Goal</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {t.drivers.map((d, driverIdx) => {
                                                        const teamTotal = getTeamBaseAndChangeoverLaps(t);
                                                        const driverTotal = getDriverBaseLaps(d) + getDriverChangeoverLaps(d);
                                                        const percentage = teamTotal === 0 ? 0 : (driverTotal / teamTotal) * 100;
                                                        return (
                                                            <tr key={d.id} className={`border-b ${isDarkMode ? 'border-gray-700' : 'border-gray-300'}`}>
                                                                <td className="py-2">{d.name}</td>
                                                                <td className="text-center">{d.targetTime}s</td>
                                                                <td className="text-center">{getDriverBaseLaps(d)}</td>
                                                                <td className="text-center">{percentage.toFixed(2)}%</td>
                                                                <td className="text-center text-green-400">{getDriverBonusLaps(d)}</td>
                                                                <td className="text-center text-purple-400">{getDriverChangeoverLaps(d)}</td>
                                                                <td className="text-center text-red-400">{getDriverBrokenLaps(d)}</td>
                                                                <td className="text-center text-red-400">{d.penaltyLaps}</td>
                                                                <td className="text-center font-bold text-yellow-400">{getDriverAchievedLaps(d)}</td>
                                                                <td className="text-center font-bold">{calculateDriverGoalLaps(d, t).toFixed(2)}</td>
                                                            </tr>
                                                        );
                                                    })}
                                                    <tr className="font-bold">
                                                        <td className="py-2">TOTAL</td>
                                                        <td></td>
                                                        <td className="text-center">{t.drivers.reduce((sum, d) => sum + getDriverBaseLaps(d), 0)}</td>
                                                        <td className="text-center">100.00%</td>
                                                        <td className="text-center text-green-400">{t.drivers.reduce((sum, d) => sum + getDriverBonusLaps(d), 0)}</td>
                                                        <td className="text-center text-purple-400">{t.drivers.reduce((sum, d) => sum + getDriverChangeoverLaps(d), 0)}</td>
                                                        <td className="text-center text-red-400">{t.drivers.reduce((sum, d) => sum + getDriverBrokenLaps(d), 0)}</td>
                                                        <td className="text-center text-red-400">{t.drivers.reduce((sum, d) => sum + d.penaltyLaps, 0)}</td>
                                                        <td className="text-center text-yellow-400">{achievedLaps}</td>
                                                        <td className="text-center">{goalLaps.toFixed(2)}</td>
                                                    </tr>
                                                </tbody>
                                            </table>
                                        </div>
                                    );
                                })}
                            </div>
                        </div>
                    )}

                    {/* Charts Modal */}
                    {showCharts && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                            <div className={`${cardBgClass} rounded-lg p-6 max-w-6xl w-full shadow-2xl max-h-[90vh] overflow-y-auto`}>
                                <div className="flex justify-between items-center mb-6">
                                    <h2 className="text-2xl font-bold">Performance Charts - {driver.name}</h2>
                                    <button
                                        onClick={() => setShowCharts(false)}
                                        className="text-gray-400 hover:text-gray-600 transition-colors"
                                    >
                                        <X className="w-6 h-6" />
                                    </button>
                                </div>

                                <div className="space-y-6">
                                    {/* Lap Times Chart */}
                                    <div className={`${cardBgSecondaryClass} rounded-lg p-5`}>
                                        <h3 className="text-lg font-bold mb-4">Lap Times Over Time</h3>
                                        <LapTimesChart driver={driver} isDarkMode={isDarkMode} />
                                    </div>

                                    {/* Delta Chart */}
                                    <div className={`${cardBgSecondaryClass} rounded-lg p-5`}>
                                        <h3 className="text-lg font-bold mb-4">Delta from Target</h3>
                                        <DeltaChart driver={driver} isDarkMode={isDarkMode} />
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Context Menu */}
                    {contextMenu.visible && (
                        <div
                            className={`fixed ${cardBgClass} border ${borderClass} rounded-lg shadow-xl py-1 z-50`}
                            style={{
                                left: `${contextMenu.x}px`,
                                top: `${contextMenu.y}px`,
                                minWidth: '200px'
                            }}
                            onClick={(e) => e.stopPropagation()}
                        >
                            <button
                                className={`w-full text-left px-4 py-2 ${hoverClass} flex items-center gap-2 text-blue-400`}
                                onClick={() => {
                                    const lap = teams[contextMenu.teamIndex]?.drivers[contextMenu.driverIndex]?.laps[contextMenu.lapIndex];
                                    if (lap) {
                                        setEditingLap({
                                            teamIndex: contextMenu.teamIndex,
                                            driverIndex: contextMenu.driverIndex,
                                            lapIndex: contextMenu.lapIndex,
                                            value: lap.time.toString()
                                        });
                                    }
                                    setContextMenu({ visible: false, x: 0, y: 0, teamIndex: null, driverIndex: null, lapIndex: null });
                                }}
                            >
                                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                                </svg>
                                Edit Lap Time
                            </button>
                            <button
                                className={`w-full text-left px-4 py-2 ${hoverClass} flex items-center gap-2 text-purple-400`}
                                onClick={() => {
                                    toggleChangeoverLap(contextMenu.teamIndex, contextMenu.driverIndex, contextMenu.lapIndex);
                                    setContextMenu({ visible: false, x: 0, y: 0, teamIndex: null, driverIndex: null, lapIndex: null });
                                }}
                            >
                                <Repeat className="w-4 h-4" />
                                {teams[contextMenu.teamIndex]?.drivers[contextMenu.driverIndex]?.laps[contextMenu.lapIndex]?.lapType === 'changeover' ? 'Remove Changeover' : 'Mark as Changeover'}
                            </button>
                            <button
                                className={`w-full text-left px-4 py-2 ${hoverClass} flex items-center gap-2 text-yellow-400`}
                                onClick={() => {
                                    toggleSafetyLap(contextMenu.teamIndex, contextMenu.driverIndex, contextMenu.lapIndex);
                                    setContextMenu({ visible: false, x: 0, y: 0, teamIndex: null, driverIndex: null, lapIndex: null });
                                }}
                            >
                                <AlertCircle className="w-4 h-4" />
                                {teams[contextMenu.teamIndex]?.drivers[contextMenu.driverIndex]?.laps[contextMenu.lapIndex]?.lapType === 'safety' ? 'Remove Safety Car' : 'Mark as Safety Car'}
                            </button>
                            <button
                                className={`w-full text-left px-4 py-2 ${hoverClass} flex items-center gap-2 text-red-400`}
                                onClick={() => {
                                    removeLap(contextMenu.teamIndex, contextMenu.driverIndex, contextMenu.lapIndex);
                                    setContextMenu({ visible: false, x: 0, y: 0, teamIndex: null, driverIndex: null, lapIndex: null });
                                }}
                            >
                                <Trash2 className="w-4 h-4" />
                                Delete Lap
                            </button>
                        </div>
                    )}
                </div>
            );
        }

        // Chart Components
        const LapTimesChart = ({ driver, isDarkMode }) => {
            const canvasRef = useRef(null);
            const chartRef = useRef(null);

            useEffect(() => {
                if (!canvasRef.current || driver.laps.length === 0) return;

                // Destroy existing chart
                if (chartRef.current) {
                    chartRef.current.destroy();
                }

                const ctx = canvasRef.current.getContext('2d');
                const textColor = isDarkMode ? '#e5e7eb' : '#1f2937';
                const gridColor = isDarkMode ? '#374151' : '#d1d5db';

                // Calculate trend line
                const lapTimes = driver.laps.map(lap => lap.time);
                const n = lapTimes.length;
                const sumX = lapTimes.reduce((sum, _, i) => sum + i, 0);
                const sumY = lapTimes.reduce((sum, val) => sum + val, 0);
                const sumXY = lapTimes.reduce((sum, val, i) => sum + (i * val), 0);
                const sumX2 = lapTimes.reduce((sum, _, i) => sum + (i * i), 0);
                const slope = (n * sumXY - sumX * sumY) / (n * sumX2 - sumX * sumX);
                const intercept = (sumY - slope * sumX) / n;
                const trendLine = lapTimes.map((_, i) => slope * i + intercept);

                // Plugin to add colored zones for lap times
                const coloredZonesPlugin = {
                    id: 'coloredZonesModal',
                    beforeDatasetsDraw: (chart) => {
                        const ctx = chart.canvas.getContext('2d');
                        const chartArea = chart.chartArea;
                        const yScale = chart.scales.y;

                        if (!chartArea || !yScale) return;

                        const targetTime = driver.targetTime;
                        const bonusThreshold = targetTime + 0.99;

                        ctx.save();

                        // Draw green zone (Bonus: target to target + 0.99s)
                        const bonusTop = yScale.getPixelForValue(targetTime);
                        const bonusBottom = yScale.getPixelForValue(bonusThreshold);
                        ctx.fillStyle = 'rgba(34, 197, 94, 0.15)';
                        ctx.fillRect(chartArea.left, bonusTop, chartArea.right - chartArea.left, bonusBottom - bonusTop);

                        // Draw blue zone (Base: target + 0.99s to max)
                        const baseTop = yScale.getPixelForValue(bonusThreshold);
                        const baseBottom = yScale.getPixelForValue(Math.max(...yScale.ticks.map(t => t.value)));
                        ctx.fillStyle = 'rgba(59, 130, 246, 0.1)';
                        ctx.fillRect(chartArea.left, baseTop, chartArea.right - chartArea.left, baseBottom - baseTop);

                        // Draw red zone (Broken: below target)
                        const brokenTop = yScale.getPixelForValue(Math.min(...yScale.ticks.map(t => t.value)));
                        const brokenBottom = yScale.getPixelForValue(targetTime);
                        ctx.fillStyle = 'rgba(239, 68, 68, 0.15)';
                        ctx.fillRect(chartArea.left, brokenBottom, chartArea.right - chartArea.left, brokenTop - brokenBottom);

                        ctx.restore();
                    }
                };

                chartRef.current = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: driver.laps.map(lap => `Lap ${lap.number}`),
                        datasets: [{
                            label: 'Lap Time (s)',
                            data: lapTimes,
                            borderColor: '#3b82f6',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            tension: 0.1,
                            fill: true
                        }, {
                            label: 'Target Time (s)',
                            data: driver.laps.map(() => driver.targetTime),
                            borderColor: '#ef4444',
                            borderDash: [5, 5],
                            pointRadius: 0,
                            fill: false
                        }, {
                            label: 'Trend',
                            data: trendLine,
                            borderColor: '#22c55e',
                            borderWidth: 2,
                            borderDash: [10, 5],
                            pointRadius: 0,
                            fill: false
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        aspectRatio: 2.5,
                        plugins: {
                            legend: {
                                labels: {
                                    color: textColor
                                }
                            }
                        },
                        scales: {
                            x: {
                                ticks: {
                                    color: textColor,
                                    maxRotation: 45,
                                    minRotation: 45
                                },
                                grid: { color: gridColor }
                            },
                            y: {
                                ticks: { color: textColor },
                                grid: { color: gridColor },
                                title: {
                                    display: true,
                                    text: 'Time (seconds)',
                                    color: textColor
                                }
                            }
                        }
                    },
                    plugins: [coloredZonesPlugin]
                });

                return () => {
                    if (chartRef.current) {
                        chartRef.current.destroy();
                    }
                };
            }, [driver, isDarkMode]);

            if (driver.laps.length === 0) {
                return <div className="text-center text-gray-400 py-8">No lap data available</div>;
            }

            return <canvas ref={canvasRef}></canvas>;
        };

        const DeltaChart = ({ driver, isDarkMode }) => {
            const canvasRef = useRef(null);
            const chartRef = useRef(null);

            useEffect(() => {
                if (!canvasRef.current || driver.laps.length === 0) return;

                // Destroy existing chart
                if (chartRef.current) {
                    chartRef.current.destroy();
                }

                const ctx = canvasRef.current.getContext('2d');
                const textColor = isDarkMode ? '#e5e7eb' : '#1f2937';
                const gridColor = isDarkMode ? '#374151' : '#d1d5db';

                // Filter out changeover laps for delta chart
                const nonChangeoverLaps = driver.laps.filter(lap => lap.lapType !== 'changeover');
                const deltas = nonChangeoverLaps.map(lap => lap.delta);

                // Calculate trend line
                const n = deltas.length;
                const sumX = deltas.reduce((sum, _, i) => sum + i, 0);
                const sumY = deltas.reduce((sum, val) => sum + val, 0);
                const sumXY = deltas.reduce((sum, val, i) => sum + (i * val), 0);
                const sumX2 = deltas.reduce((sum, _, i) => sum + (i * i), 0);
                const slope = (n * sumXY - sumX * sumY) / (n * sumX2 - sumX * sumX);
                const intercept = (sumY - slope * sumX) / n;
                const trendLine = deltas.map((_, i) => slope * i + intercept);

                // Plugin to add colored zones for delta chart
                const deltaZonesPlugin = {
                    id: 'deltaZonesModal',
                    beforeDatasetsDraw: (chart) => {
                        const ctx = chart.canvas.getContext('2d');
                        const chartArea = chart.chartArea;
                        const yScale = chart.scales.y;

                        if (!chartArea || !yScale) return;

                        ctx.save();

                        // Draw green zone (Bonus: 0 to +0.99s delta)
                        const bonusTop = yScale.getPixelForValue(0);
                        const bonusBottom = yScale.getPixelForValue(0.99);
                        ctx.fillStyle = 'rgba(34, 197, 94, 0.15)';
                        ctx.fillRect(chartArea.left, bonusTop, chartArea.right - chartArea.left, bonusBottom - bonusTop);

                        // Draw blue zone (Base: +0.99s to max)
                        const baseTop = yScale.getPixelForValue(0.99);
                        const baseBottom = yScale.getPixelForValue(Math.max(...yScale.ticks.map(t => t.value)));
                        ctx.fillStyle = 'rgba(59, 130, 246, 0.1)';
                        ctx.fillRect(chartArea.left, baseTop, chartArea.right - chartArea.left, baseBottom - baseTop);

                        // Draw red zone (Broken: negative delta)
                        const brokenTop = yScale.getPixelForValue(Math.min(...yScale.ticks.map(t => t.value)));
                        const brokenBottom = yScale.getPixelForValue(0);
                        ctx.fillStyle = 'rgba(239, 68, 68, 0.15)';
                        ctx.fillRect(chartArea.left, brokenBottom, chartArea.right - chartArea.left, brokenTop - brokenBottom);

                        ctx.restore();
                    }
                };

                chartRef.current = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: nonChangeoverLaps.map(lap => `Lap ${lap.number}`),
                        datasets: [{
                            label: 'Delta from Target (s)',
                            data: deltas,
                            backgroundColor: nonChangeoverLaps.map(lap => {
                                if (lap.lapType === 'bonus') return 'rgba(34, 197, 94, 0.6)';
                                if (lap.lapType === 'broken') return 'rgba(239, 68, 68, 0.6)';
                                return 'rgba(59, 130, 246, 0.6)';
                            }),
                            borderColor: nonChangeoverLaps.map(lap => {
                                if (lap.lapType === 'bonus') return '#22c55e';
                                if (lap.lapType === 'broken') return '#ef4444';
                                return '#3b82f6';
                            }),
                            borderWidth: 2,
                            order: 2
                        }, {
                            label: 'Trend',
                            data: trendLine,
                            type: 'line',
                            borderColor: '#22c55e',
                            borderWidth: 2,
                            borderDash: [10, 5],
                            pointRadius: 0,
                            fill: false,
                            order: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        aspectRatio: 2.5,
                        plugins: {
                            legend: {
                                labels: {
                                    color: textColor
                                }
                            }
                        },
                        scales: {
                            x: {
                                ticks: {
                                    color: textColor,
                                    maxRotation: 45,
                                    minRotation: 45
                                },
                                grid: { color: gridColor }
                            },
                            y: {
                                ticks: { color: textColor },
                                grid: { color: gridColor },
                                title: {
                                    display: true,
                                    text: 'Delta (seconds)',
                                    color: textColor
                                }
                            }
                        }
                    },
                    plugins: [deltaZonesPlugin]
                });

                return () => {
                    if (chartRef.current) {
                        chartRef.current.destroy();
                    }
                };
            }, [driver, isDarkMode]);

            if (driver.laps.length === 0) {
                return <div className="text-center text-gray-400 py-8">No lap data available</div>;
            }

            return <canvas ref={canvasRef}></canvas>;
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<BlindFreddyRaceTimer />);
    </script>
</body>
</html>